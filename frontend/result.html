<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>å‹æ•—çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --castle-bg-1: #f1e7d6;
      --castle-bg-2: #d2c0a0;
      --castle-bg-3: #b59c78;
      --castle-ink: #2b2b2b;
      --castle-panel: #f8f1e3;
      --castle-border: #d1c0a2;
      --castle-shadow: rgba(27, 20, 10, 0.15);
    }
    body {
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      margin: 16px;
      color: var(--castle-ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,0.55), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 100% 0%, rgba(0,0,0,0.08), rgba(0,0,0,0)),
        linear-gradient(160deg, var(--castle-bg-1), var(--castle-bg-2) 60%, var(--castle-bg-3));
    }
    h1 { font-size: 1.4rem; margin: 0 0 8px; }
    .box {
      background: var(--castle-panel);
      border: 1px solid var(--castle-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px var(--castle-shadow);
      margin-bottom: 12px;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    .big { font-size: 1.6rem; font-weight: 800; margin: 6px 0; }
    .muted { color:#666; font-size:.9rem; }
    .note { color:#666; font-size:.9rem; margin-top:6px; }
    .success { color:#006400; }
    .danger { color:#b00020; }

    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; cursor:pointer; }
    .primary { background:#0066cc; color:#fff; }
    .ghost { background:#eee; color:#333; }
    button:disabled { opacity: .4; cursor: not-allowed; }

    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:.95rem; }
    th { color:#666; font-weight:600; }
    .tag { font-size:.78rem; color:#555; background:#f3f4f6; padding:2px 6px; border-radius:999px; }
    .dead { opacity:.55; }
    .log { white-space:pre-wrap; font-size:.92rem; }

    .toggle {
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border:1px solid #eee; border-radius:12px;
      background:#fafafa;
    }
    .toggle label { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .toggle input { transform: scale(1.2); }
    .warn { color:#b00020; font-size:.85rem; }
    .hint { color:#666; font-size:.85rem; margin-top:6px; }

    .host-banner {
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: min(720px, calc(100% - 24px));
      background: rgba(17, 24, 39, 0.95);
      color: #f9fafb;
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      display: none;
      z-index: 9999;
    }
    .host-banner .title { font-weight: 800; margin-bottom: 2px; }
    .host-banner .desc { font-size: .9rem; opacity: .9; }
    .host-banner .actions { margin-top: 10px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .host-banner .btn {
      padding: 10px 14px; border-radius: 999px; border: none; cursor:pointer; font-size: 1rem;
    }
    .host-banner .btn.primary { background:#22c55e; color:#052e16; font-weight:800; }
    .host-banner .btn.ghost { background:#374151; color:#f9fafb; }

    /* â˜…è¿½åŠ ï¼šå…¬é–‹ä¸­ã®èµ¤å¸¯ */
    .reveal-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 10px 12px;
      background: rgba(176, 0, 32, 0.96);
      color: #fff;
      font-weight: 900;
      letter-spacing: .06em;
      text-align: center;
      z-index: 10000;
      display: none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    /* èµ¤å¸¯ã¶ã‚“ã®ä½™ç™½ï¼ˆè¡¨ç¤ºæ™‚ã ã‘ä»˜ä¸ï¼‰ */
    body.reveal-on { padding-top: 46px; }
    /* â˜…è¿½åŠ ï¼šå½¹è·å…¬é–‹ä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®š */
    body.no-scroll {
    overflow: hidden;
    touch-action: none;   /* ã‚¹ãƒãƒ›å¯¾ç­– */
    }

  </style>
</head>
<body>
  <!-- â˜…è¿½åŠ ï¼šå…¬é–‹ä¸­ã®èµ¤å¸¯ -->
  <div class="reveal-bar" id="revealBar">âš  å½¹è·å…¬é–‹ä¸­ï¼ˆã‚¿ãƒƒãƒ—ã§OFFï¼‰</div>

  <h1>å‹æ•—çµæœ</h1>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">ã‚²ãƒ¼ãƒ çŠ¶æ…‹ï¼š<span class="pill" id="game-status">...</span></div>
        <div class="muted">åˆ¤å®šï¼š<span class="pill" id="judge-result">...</span></div>
        <div class="note" id="host-note"></div>
      </div>
      <div class="row">
        <button class="ghost" id="refresh">æ›´æ–°</button>
        <button class="ghost" id="to-role">å½¹è·ç¢ºèªã¸</button>
        <button class="primary" id="to-day">æ˜¼ã¸</button>
        <button class="primary" id="to-night">å¤œã¸</button>
      </div>
    </div>

    <div class="big" id="headline">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="muted" id="reason"></div>

    <div class="row" id="reveal-row" style="margin-top:10px; justify-content:space-between;">
      <div class="toggle">
        <label>
          <input type="checkbox" id="reveal-toggle" />
          <span>å½¹è·ã‚’å…¬é–‹ã™ã‚‹ï¼ˆå¸ä¼šç”¨ï¼‰</span>
        </label>
      </div>
      <div class="warn" id="reveal-warn">â€» å‘¨å›²ã®äººã«è¦‹ã›ã‚‹ç›´å‰ã«ON</div>
    </div>
    <div class="hint" id="reveal-hint">æ±ºç€å¾Œã«ã®ã¿æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:700;">ç”Ÿå­˜çŠ¶æ³</div>
      <div class="row">
        <span class="tag" id="count-wolf">WOLF: -</span>
        <span class="tag" id="count-village">VILLAGE: -</span>
        <span class="tag" id="count-all">ALL: -</span>
      </div>
    </div>

    <div id="members-area"></div>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ¡ãƒ¢</div>
    <div class="log" id="log"></div>
  </div>

  <!-- å¸ä¼šå‘ã‘ã®å…¬é–‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯ä½¿ç”¨ã—ãªã„ -->

  <script>
    const qs = new URLSearchParams(location.search);
    const gameId = qs.get("game_id");
    const playerId = qs.get("player_id");

    const gameStatusEl = document.getElementById("game-status");
    const judgeResultEl = document.getElementById("judge-result");
    const headlineEl = document.getElementById("headline");
    const reasonEl = document.getElementById("reason");
    const membersArea = document.getElementById("members-area");
    const logEl = document.getElementById("log");
    const hostNoteEl = document.getElementById("host-note");

    const wolfCntEl = document.getElementById("count-wolf");
    const villageCntEl = document.getElementById("count-village");
    const allCntEl = document.getElementById("count-all");

    const btnToDay = document.getElementById("to-day");
    const btnToNight = document.getElementById("to-night");

    const revealToggle = document.getElementById("reveal-toggle");
    const revealHint = document.getElementById("reveal-hint");
    const revealRow = document.getElementById("reveal-row");
    const revealWarn = document.getElementById("reveal-warn");

    const revealBar = document.getElementById("revealBar");

    revealToggle.checked = false;
    let isHost = false;


    function log(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      logEl.appendChild(div);
    }

    function jump(path) {
      location.href = `/frontend/${path}?game_id=${encodeURIComponent(gameId)}&player_id=${encodeURIComponent(playerId)}`;
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, data };
    }

    async function fetchMe() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/me?player_id=${encodeURIComponent(playerId)}`);
      if (!res.ok) throw new Error(`meå–å¾—å¤±æ•—(${res.status})`);
      return await res.json();
    }

    async function fetchRevealRoles() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/reveal_roles`);
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, status: res.status, data };
    }

    function normalizeResult(r) {
      return String(r || "").toUpperCase();
    }

    function isFinished(jr) {
      return jr === "VILLAGE_WIN" || jr === "WOLF_WIN";
    }

    function updateRevealBar() {
      const on = !!revealToggle.checked;
      revealBar.style.display = on ? "block" : "none";
      document.body.classList.toggle("reveal-on", on);
    }

    function applyRevealGuard(jr) {
      const finished = isFinished(jr);

      if (!finished) {
        if (revealToggle.checked) {
          revealToggle.checked = false;
          updateRevealBar();
          updateScrollLock(false); // â˜…è¿½åŠ ï¼šå¼·åˆ¶OFFæ™‚ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è§£é™¤
        }
        revealToggle.disabled = true;
        revealHint.textContent = "æ±ºç€å¾Œã«ã®ã¿æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚";
      } else {
        revealToggle.disabled = false;
        revealHint.textContent = "å¸ä¼šãŒå…¨å“¡ã«è¦‹ã›ã‚‹ç›´å‰ã ã‘ONã«ã—ã¦ãã ã•ã„ã€‚";
      }
    }

    async function setReveal(on, opts = {}) {
      const fromServer = !!opts.fromServer;
      const doLog = (opts.log !== false);
      if (!fromServer && !isHost) return;

      revealToggle.checked = !!on;
      updateRevealBar();
      updateScrollLock(on); // â˜…è¿½åŠ ï¼šå…¬é–‹ä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®š

      if (lastMembers) renderMembers(lastMembers, lastJudge);
      if (doLog) log(on ? "å½¹è·å…¬é–‹ï¼šONï¼ˆå¸ä¼šç”¨ï¼‰" : "å½¹è·å…¬é–‹ï¼šOFF");

      if (!fromServer) {
        try {
          const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/reveal_roles`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              requester_member_id: playerId,
              enabled: !!on,
            }),
          });
          if (!res.ok) {
            log("å½¹è·å…¬é–‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
          }
        } catch (e) {
          log("å½¹è·å…¬é–‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
        }
      }
    }

    // â˜…è¿½åŠ ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šã®ON/OFF
    function updateScrollLock(on) {
    document.body.classList.toggle("no-scroll", on);
    }

    function applyHostOnlyUI(isHost) {
      if (isHost) {
        revealRow.style.display = "flex";
        revealWarn.style.display = "block";
        revealHint.style.display = "block";
        return;
      }

      revealToggle.disabled = true;
      revealRow.style.display = "none";
      revealWarn.style.display = "none";
      revealHint.style.display = "none";
    }

    function renderHeadline(judge, game) {
      const jr = normalizeResult(judge?.result);
      const gs = String(game?.status || "").toUpperCase();

      judgeResultEl.textContent = jr || "-";
      gameStatusEl.textContent = gs || "-";

      if (jr === "VILLAGE_WIN") {
        headlineEl.innerHTML = `ğŸ <span class="success">æ‘äººé™£å–¶ã®å‹åˆ©</span>`;
      } else if (jr === "WOLF_WIN") {
        headlineEl.innerHTML = `ğŸ <span class="danger">äººç‹¼é™£å–¶ã®å‹åˆ©</span>`;
      } else if (jr === "ONGOING") {
        headlineEl.textContent = "é€²è¡Œä¸­ï¼ˆã¾ã æ±ºç€ã—ã¦ã„ã¾ã›ã‚“ï¼‰";
      } else {
        headlineEl.textContent = "åˆ¤å®šä¸æ˜";
      }

      reasonEl.textContent = judge?.reason
        ? `ç†ç”±ï¼š${judge.reason}`
        : `ï¼ˆgame.status: ${gs} / judge: ${jr}ï¼‰`;

      const finished = isFinished(jr);
      btnToDay.disabled = finished;
      btnToNight.disabled = finished;

      applyRevealGuard(jr);
      return jr;
    }

    function renderMembers(members, judge) {
      if (!Array.isArray(members)) {
        membersArea.textContent = "ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
      }

      const wolfAlive = judge?.wolf_alive ?? null;
      const villageAlive = judge?.village_alive ?? null;

      if (wolfAlive != null) wolfCntEl.textContent = `WOLF: ${wolfAlive}`;
      if (villageAlive != null) villageCntEl.textContent = `VILLAGE: ${villageAlive}`;
      allCntEl.textContent = `ALL: ${members.length}`;

      const reveal = revealToggle.checked;

      const sorted = members.slice().sort((a,b) => {
        const aa = (a.alive !== false);
        const bb = (b.alive !== false);
        if (aa === bb) return (a.order_no||999) - (b.order_no||999);
        return aa ? -1 : 1;
      });

      function translateTeam(team) {
        const t = String(team || "").toUpperCase();
        if (t === "WOLF") return "äººç‹¼é™£å–¶";
        if (t === "VILLAGE") return "æ‘äººé™£å–¶";
        return team || "-";
      }

      function translateRole(role) {
        const r = String(role || "").toUpperCase();
        if (r === "WEREWOLF") return "äººç‹¼";
        if (r === "SEER") return "å ã„å¸«";
        if (r === "KNIGHT") return "é¨å£«";
        if (r === "VILLAGER") return "æ‘äºº";
        if (r === "MADMAN") return "ç‹‚äºº";
        if (r === "MEDIUM") return "éœŠåª’å¸«";
        return role || "-";
      }

      const rows = sorted.map(m => {
        const alive = (m.alive !== false);
        const name = m.display_name || m.name || m.id;

        const team = reveal ? translateTeam(m.team) : "???";
        const role = reveal ? translateRole(m.role_type) : "???";

        return `
          <tr class="${alive ? "" : "dead"}">
            <td>${name}</td>
            <td>${alive ? "ç”Ÿå­˜" : "æ­»äº¡"}</td>
            <td>${team}</td>
            <td>${role}</td>
          </tr>
        `;
      }).join("");

      membersArea.innerHTML = `
        <table>
          <thead>
            <tr><th>åå‰</th><th>çŠ¶æ…‹</th><th>é™£å–¶</th><th>å½¹è·</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    let lastGame = null;
    let lastJudge = null;
    let lastMembers = null;
    let lastMe = null;
    let prevJudgeResult = "";

    async function sync() {
      logEl.textContent = "";

      if (!gameId || !playerId) {
        log("URLã« game_id / player_id ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const [gameRes, judgeRes, memRes, me, revealRes] = await Promise.all([
        fetchJson(`/api/games/${encodeURIComponent(gameId)}`),
        fetchJson(`/api/games/${encodeURIComponent(gameId)}/judge`),
        fetchJson(`/api/games/${encodeURIComponent(gameId)}/members`),
        fetchMe().catch(() => null),
        fetchRevealRoles().catch(() => ({ ok: false, data: {} })),
      ]);
      if (!gameRes.ok) {
        log(`gameå–å¾—å¤±æ•—(${gameRes.status}): ${JSON.stringify(gameRes.data)}`);
        return;
      }
      if (!judgeRes.ok) {
        log(`judgeå–å¾—å¤±æ•—(${judgeRes.status}): ${JSON.stringify(judgeRes.data)}`);
      }
      if (!memRes.ok) {
        log(`memberså–å¾—å¤±æ•—(${memRes.status}): ${JSON.stringify(memRes.data)}`);
      }

      lastGame = gameRes.data;
      lastJudge = judgeRes.data;
      lastMembers = memRes.data;
      lastMe = me;
      isHost = !!lastMe?.is_host;
      applyHostOnlyUI(isHost);
      if (!isHost) {
        hostNoteEl.textContent = "å½¹è·å…¬é–‹ã¯å¸ä¼šãŒæ“ä½œã—ã¾ã™";
        hostNoteEl.style.display = "block";
      } else {
        hostNoteEl.textContent = "";
        hostNoteEl.style.display = "none";
      }

      const currentJr = renderHeadline(lastJudge, lastGame);
      renderMembers(lastMembers, lastJudge);

      prevJudgeResult = currentJr;

      updateRevealBar(); // â˜…èµ·å‹•ç›´å¾Œ/æ›´æ–°æ™‚ã®åæ˜ 

      if (revealRes.ok && typeof revealRes.data?.enabled === "boolean") {
        await setReveal(revealRes.data.enabled, { fromServer: true, log: false });
      }

      if (isFinished(currentJr)) {
        log("æ±ºç€æ¸ˆã¿ã§ã™ã€‚ã€Œæ˜¼ã¸ã€ã€Œå¤œã¸ã€ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚å¿…è¦ãªã‚‰å½¹è·å…¬é–‹ãƒˆã‚°ãƒ«ã‚’ONã«ã—ã¦ãã ã•ã„ã€‚");
      } else {
        log("é€²è¡Œä¸­ã§ã™ã€‚æ±ºç€å¾Œã«å½¹è·å…¬é–‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚");
      }
    }

    // ãƒˆã‚°ãƒ«æ“ä½œï¼ˆæ±ºç€æ¸ˆã¿ã®æ™‚ã®ã¿ONå¯ï¼‰
    revealToggle.addEventListener("change", () => {
      if (!lastMe?.is_host) {
        revealToggle.checked = false;
        updateRevealBar();
        log("å¸ä¼šã®ã¿æ“ä½œã§ãã¾ã™ã€‚");
        return;
      }
      const jr = normalizeResult(lastJudge?.result);
      if (!isFinished(jr)) {
        revealToggle.checked = false;
        updateRevealBar();
        log("ã¾ã æ±ºç€ã—ã¦ã„ãªã„ãŸã‚ã€å½¹è·å…¬é–‹ã¯ã§ãã¾ã›ã‚“ã€‚");
        return;
      }
      setReveal(revealToggle.checked);
    });

    document.getElementById("refresh").addEventListener("click", sync);
    document.getElementById("to-role").addEventListener("click", () => jump("role_confirm.html"));
    btnToDay.addEventListener("click", () => jump("day.html"));
    btnToNight.addEventListener("click", () => jump("role_confirm.html"));

    setInterval(sync, 3000);
    sync();

    // â˜…è¿½åŠ ï¼šèµ¤å¸¯ã‚¿ãƒƒãƒ—ã§å³OFFï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—çµ‚äº†ï¼‰
    revealBar.addEventListener("click", () => {
      if (!revealToggle.checked) return; // ã™ã§ã«OFFãªã‚‰ä½•ã‚‚ã—ãªã„
      if (!isHost) return;
      setReveal(false);
      log("å½¹è·å…¬é–‹ï¼šèµ¤å¸¯ã‚¿ãƒƒãƒ—ã§OFFã«ã—ã¾ã—ãŸ");
    });

  </script>
</body>
</html>
