<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>夜フェーズ - 待機</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --castle-bg-1: #f1e7d6;
      --castle-bg-2: #d2c0a0;
      --castle-bg-3: #b59c78;
      --castle-ink: #2b2b2b;
      --castle-panel: #f8f1e3;
      --castle-border: #d1c0a2;
      --castle-shadow: rgba(27, 20, 10, 0.15);
    }
    body {
      font-family: "Yu Gothic", "Yu Gothic UI", "Meiryo", sans-serif;
      margin: 16px;
      color: var(--castle-ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,0.55), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 100% 0%, rgba(0,0,0,0.08), rgba(0,0,0,0)),
        linear-gradient(160deg, var(--castle-bg-1), var(--castle-bg-2) 60%, var(--castle-bg-3));
    }
    h1 { font-size: 1.4rem; margin: 0 0 8px; }
    .box {
      background: var(--castle-panel);
      border: 1px solid var(--castle-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px var(--castle-shadow);
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; }
    .primary { background:#0066cc; color:#fff; }
    .ghost { background:#eee; color:#333; }
    .danger { background:#b00020; color:#fff; }
    .status { margin-top:8px; color:#444; }
    .log { margin-top:10px; white-space:pre-wrap; font-size:.92rem; }
    .log .error { color:#b00020; }
    .log .success { color:#006400; }
    .small { font-size:.88rem; color:#666; }
    .note { font-size:.88rem; color:#666; margin-top:10px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
  </style>
</head>
<body>
  <h1>夜フェーズ：待機</h1>

  <div class="box">
    <div class="small">
      村人 / 狂人など「夜のアクションがない」役職用の待機画面です。<br>
      夜明け処理（朝の結果反映）は、司会（ホスト）が実行してください。
    </div>
    <div class="note" id="host-note"></div>

    <div class="status" id="status">読み込み中...</div>
    <div class="small" id="host-status"></div>

    <div class="row">
      <button class="ghost" id="refresh">状態を更新</button>
      <button class="primary" id="wait-done">待機した</button>
      <button class="primary" id="go-morning">朝の結果（夜明け処理）へ</button>
      <button class="danger" id="go-night">（誤操作対策）夜画面へ戻す</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script src="/frontend/js/night_common.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const gameId = qs.get("game_id");
    const playerId = qs.get("player_id");

    // ★追加：勝敗確定なら result.html へ
    setupAutoResultRedirect(gameId, playerId);

    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const goMorningBtn = document.getElementById("go-morning");
    const hostStatusEl = document.getElementById("host-status");
    const hostNoteEl = document.getElementById("host-note");
    const waitDoneBtn = document.getElementById("wait-done");

    function waitDoneKey(nightNo) {
      return `jinrou_wait_done_${gameId}_${playerId}_${nightNo}`;
    }

    function applyWaitDoneUI(done, nightNo) {
      if (!waitDoneBtn) return;
      if (done) {
        waitDoneBtn.disabled = true;
        waitDoneBtn.textContent = "待機完了";
        waitDoneBtn.title = nightNo ? `夜${nightNo}は完了しました` : "この夜は完了しました";
      } else {
        waitDoneBtn.disabled = false;
        waitDoneBtn.textContent = "待機した";
        waitDoneBtn.title = "";
      }
    }

    function log(msg, type) {
      const div = document.createElement("div");
      div.textContent = msg;
      if (type) div.className = type;
      logEl.appendChild(div);
    }

    async function fetchGame() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}`);
      if (!res.ok) throw new Error(`game取得失敗(${res.status})`);
      return await res.json();
    }

    async function fetchMe() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/me?player_id=${encodeURIComponent(playerId)}`);
      if (!res.ok) throw new Error(`me取得失敗(${res.status})`);
      return await res.json();
    }

    async function fetchNightActionsStatus() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/night_actions_status`);
      if (!res.ok) throw new Error(`night_actions_status取得失敗(${res.status})`);
      return await res.json();
    }

    function jump(path) {
      location.href = `/frontend/${path}?game_id=${encodeURIComponent(gameId)}&player_id=${encodeURIComponent(playerId)}`;
    }

    async function sync() {
      if (!gameId || !playerId) {
        statusEl.textContent = "game_id / player_id がURLにありません。";
        return;
      }
      try {
        const [g, me, actions] = await Promise.all([fetchGame(), fetchMe(), fetchNightActionsStatus()]);
        const st = String(g.status || "").toUpperCase();
        statusEl.innerHTML = `ゲーム状態：<span class="pill">${st}</span>`;
        const isHost = !!me?.is_host;
        if (me?.status === "dead") {
          jump("spectator.html");
          return;
        }
        if (!isHost) {
          hostNoteEl.textContent = "夜の進行（夜明け処理）は司会が行います";
          hostNoteEl.style.display = "block";
        } else {
          hostNoteEl.textContent = "";
          hostNoteEl.style.display = "none";
        }
        goMorningBtn.disabled = !isHost;
        goMorningBtn.title = isHost ? "" : "司会のみ実行できます";
        hostStatusEl.textContent = isHost
          ? `夜行動の進捗：人狼 ${actions.wolves_done}/${actions.wolves_total}・占い師 ${actions.seer_done}/${actions.seer_total}・騎士 ${actions.knight_done}/${actions.knight_total}（全完了: ${actions.all_done ? "はい" : "いいえ"}）`
          : "";

        if (st === "NIGHT") {
          const nightNo = g.curr_night || 1;
          const done = localStorage.getItem(waitDoneKey(nightNo)) === "1";
          applyWaitDoneUI(done, nightNo);
        } else {
          applyWaitDoneUI(false, null);
        }

        // 夜が終わってDAY_DISCUSSIONになっていたら朝結果へ
        if (st === "DAY_DISCUSSION") jump("morning.html");
        // FINISHEDなら結果へ
        if (st === "FINISHED" || st === "VILLAGE_WIN" || st === "WOLF_WIN") {
          log("ゲームが終了しています。", "success");
          jump("result.html");
        }
      } catch (e) {
        console.error(e);
        log(String(e), "error");
        statusEl.textContent = "状態取得に失敗しました。";
      }
    }

    // ポーリングで状態変化を追う
    setInterval(sync, 1500);

    document.getElementById("refresh").addEventListener("click", sync);
    waitDoneBtn.addEventListener("click", async () => {
      try {
        const g = await fetchGame();
        const st = String(g.status || "").toUpperCase();
        if (st !== "NIGHT") {
          log("夜フェーズではありません。", "error");
          return;
        }
        const nightNo = g.curr_night || 1;
        localStorage.setItem(waitDoneKey(nightNo), "1");
        applyWaitDoneUI(true, nightNo);
        log("待機しました。", "success");
      } catch (e) {
        log("待機の記録に失敗しました。", "error");
      }
    });
    document.getElementById("go-morning").addEventListener("click", () => jump("morning.html"));
    document.getElementById("go-night").addEventListener("click", () => jump("role_confirm.html"));

    sync();
  </script>
</body>
</html>
