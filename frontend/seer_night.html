<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>夜フェーズ - 占い師</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { font-size: 1.4rem; margin-bottom: 8px; }

    .header-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:8px;
    }
    .header-main { font-size:1.1rem; font-weight:600; }
    .header-sub  { font-size:0.85rem; color:#666; }
    .you-info { font-size:0.85rem; color:#444; }

    .members {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }
    .member-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      background: #fff;
      font-size: 0.9rem;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height:72px;
      box-shadow:0 1px 2px rgba(0,0,0,0.04);
      transition: box-shadow 0.15s ease, border-color 0.15s ease, transform 0.12s ease;
    }
    .member-card .name { font-weight:600; }
    .member-card .sub  { font-size:0.75rem; color:#777; }

    .member-card.dead,
    .member-card.self {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .member-card.selected {
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0,102,204,0.18);
      transform: translateY(-1px);
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
    }
    button:disabled { opacity: 0.5; }
    .primary { background: #0066cc; color: #fff; }

    .log { margin-top: 16px; font-size: 0.9rem; white-space: pre-wrap; }
    .log > div { margin-bottom:4px; }
    .error { color: #b00020; }
    .success { color: #006400; }

    .status { font-size:0.9rem; margin-bottom:8px; color:#444; }
  </style>
</head>
<body>
  <h1>夜フェーズ：占い師</h1>

  <div class="header-row">
    <div>
      <div class="header-main">今夜の占い</div>
      <div class="header-sub">自分と死亡者は占えません。生存中の他プレイヤーから 1人だけ選んでください。</div>
    </div>
    <div class="you-info">
      あなた：<strong id="me-name">（読み込み中）</strong>（占い師）
    </div>
  </div>

  <div id="status" class="status"></div>

  <div id="member-list" class="members"></div>

  <button id="inspect-btn" class="primary" disabled>このプレイヤーを占う</button>

  <div id="result" class="log"></div>
  <div id="host-status" class="status"></div>
  <button id="host-morning" class="primary" style="margin-top:8px; display:none;">朝の結果へ</button>

  <!-- 共通ロジック -->
  <script src="/frontend/js/night_common.js"></script>
  <script>
    (function () {

      const params = new URLSearchParams(location.search);
      const game_id = params.get("game_id");
      const player_id = params.get("player_id");

      // ★追加：勝敗確定なら result.html へ
      setupAutoResultRedirect(game_id, player_id);

      const meNameEl = document.getElementById("me-name");
      const hostMorningBtn = document.getElementById("host-morning");

      hostMorningBtn.addEventListener("click", () => {
        location.href = `/frontend/morning.html?game_id=${encodeURIComponent(game_id)}&player_id=${encodeURIComponent(player_id)}`;
      });

      JinrouNight.initNightRolePage({
        expectedRole: "seer",
        elements: {
          statusId: "status",
          membersId: "member-list",
          buttonId: "inspect-btn",
          resultId: "result",
        },

        // ✅ 追加：占い済みなら最初からボタン非表示＋ロック
        // （要：GET /api/games/{game_id}/seer/{seer_member_id}/inspect/status）
        checkAlreadyDone: async ({ gameId, me }) => {
          const url =
            `/api/games/${encodeURIComponent(gameId)}` +
            `/seer/${encodeURIComponent(me.player_id)}/inspect/status`;

          const res = await fetch(url);
          if (!res.ok) return { done: false };

          const data = await res.json();
          if (!data.done) return { done: false };

          return {
            done: true,
            kind: "seer_inspect",
            target_member_id: data.target_member_id || null,
            message: "今夜の占いはすでに完了しています。",
          };
        },

        // ★ seer_member_id は GameMember.id (= /me の player_id)
        //   /api/games/{game_id}/seer/{seer_member_id}/inspect
        buildEndpoint: (gameId, me) => {
          if (!me || !me.player_id) {
            throw new Error("占い師情報の取得に失敗しました（player_id 不正）");
          }
          return `/api/games/${encodeURIComponent(gameId)}/seer/${encodeURIComponent(me.player_id)}/inspect`;
        },

        // ★ Body は target_member_id だけでOK
        buildRequestBody: ({ targetMember }) => ({
          target_member_id: targetMember.id,
        }),

        buildSuccessMessage: ({ data, targetMember }) => {
          const isWolf = data.is_wolf;
          const name =
            data.target_name ||
            targetMember.display_name ||
            targetMember.name ||
            "相手";
          return isWolf
            ? `🔴 ${name} さんは「人狼」です。`
            : `🔵 ${name} さんは「人狼ではありません」。`;
        },

        texts: {
          loadingMe: "占い師の情報を読み込み中...",
          loadingGame: "プレイヤー一覧を取得中...",
          selectPrompt: "占う相手を選んでください。",
          roleMismatch:
            "あなたは占い師ではありません。この画面からは操作できません。",
          doneStatus:
            "今夜の占いは完了しました。他の人のターンを待ってください。",
        },

        // 占い師用のメンバー表示
        renderMembers: ({
          members,
          me,
          containerEl,
          expectedRole,
          actionDone,
          onSelect,
        }) => {
          if (!containerEl || !Array.isArray(members)) return;
          containerEl.innerHTML = "";

          const selfId = me?.player_id || me?.game_member_id;

          // ヘッダー「あなた：◯◯」用に自分の GameMember を見つける
          const meMember = members.find((m) => m.id === selfId);
          if (meNameEl) {
            const displayName =
              meMember?.display_name || meMember?.name || "あなた";
            meNameEl.textContent = displayName;
          }

          members.forEach((m) => {
            const card = document.createElement("div");
            card.className = "member-card";
            card.dataset.memberId = m.id;

            const isAlive =
              m.is_alive !== undefined ? m.is_alive : m.alive !== false;
            const isSelf = selfId && m.id === selfId;
            const roleMismatch = expectedRole && me?.role !== expectedRole;

            if (!isAlive) card.classList.add("dead");
            if (isSelf) card.classList.add("self");

            const name = m.display_name || m.name || `プレイヤー ${m.id}`;

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.textContent = name;

            const subDiv = document.createElement("div");
            subDiv.className = "sub";
            if (!isAlive) {
              subDiv.textContent = "死亡しているため占えません";
            } else if (isSelf) {
              subDiv.textContent = "自分自身は占えません";
            } else {
              subDiv.textContent = "タップして占い対象として選択";
            }

            card.appendChild(nameDiv);
            card.appendChild(subDiv);

            // actionDone=true（占い済み）なら、最初から全カード選択不可
            if (!isAlive || isSelf || actionDone || roleMismatch) {
              card.style.pointerEvents = "none";
            } else {
              card.addEventListener("click", () => {
                if (actionDone) return;
                containerEl
                  .querySelectorAll(".member-card")
                  .forEach((el) => el.classList.remove("selected"));
                card.classList.add("selected");
                onSelect(m);
              });
            }

            containerEl.appendChild(card);
          });
        },
      });

      if (JinrouNight?.setupHostNightPanel) {
        JinrouNight.setupHostNightPanel(game_id, player_id, {
          statusId: "host-status",
          buttonId: "host-morning",
        });
        setInterval(() => {
          JinrouNight.setupHostNightPanel(game_id, player_id, {
            statusId: "host-status",
            buttonId: "host-morning",
          });
        }, 2000);
      }
    })();
  </script>
</body>
</html>
