<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Jinrou | ãƒ«ãƒ¼ãƒ å‚åŠ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --castle-bg-1: #f1e7d6;
      --castle-bg-2: #d2c0a0;
      --castle-bg-3: #b59c78;
      --castle-ink: #2b2b2b;
      --castle-panel: #f8f1e3;
      --castle-border: #d1c0a2;
      --castle-shadow: rgba(27, 20, 10, 0.15);
    }
    body {
      font-family: "Yu Gothic", "Yu Gothic UI", "Meiryo", sans-serif;
      margin: 16px;
      color: var(--castle-ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,0.55), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 100% 0%, rgba(0,0,0,0.08), rgba(0,0,0,0)),
        linear-gradient(160deg, var(--castle-bg-1), var(--castle-bg-2) 60%, var(--castle-bg-3));
    }
    h1 { margin:0 0 6px; font-size:1.25rem; }
    .muted { color:#666; font-size:.92rem; }
    .box {
      background: var(--castle-panel);
      border: 1px solid var(--castle-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px var(--castle-shadow);
      margin: 12px 0;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    input { padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; flex:1; min-width: 220px; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .primary { background:#0066cc; color:#fff; }
    .ghost { background:#eee; color:#333; }
    .danger { background:#b00020; color:#fff; }
    .ok { color:#065f46; font-weight:700; }
    .err { color:#b00020; white-space:pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem; }
    .list { margin:8px 0 0; padding-left: 18px; }
    .small { font-size:.85rem; color:#666; }
    .hr { height:1px; background:#eee; margin:10px 0; }
    .avatar-preview {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 1px solid #ddd;
      background: #f5f5f5;
      object-fit: cover;
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸº ãƒ«ãƒ¼ãƒ å‚åŠ </h1>
  <div class="muted">åå‰ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€å¸ä¼šãŒé–‹å§‹ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•çš„ã«å½¹è·ç¢ºèªã¸é€²ã¿ã¾ã™ã€‚</div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div>room_nameï¼š<span class="pill" id="roomName">ï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰</span></div>
        <div>room_idï¼š<span class="pill mono" id="roomId">-</span></div>
        <div>ã‚ãªãŸï¼š<span class="pill" id="youName">æœªç™»éŒ²</span></div>
      </div>
      <div class="row">
        <button class="ghost" id="clearBtn">ã“ã®ç«¯æœ«ã®å‚åŠ æƒ…å ±ã‚’æ¶ˆã™</button>
      </div>
    </div>

    <div class="hr"></div>

    <div style="font-weight:700;">â‘  åå‰ã‚’ç™»éŒ²ï¼ˆrosterï¼‰</div>
    <div class="row" style="margin-top:8px;">
      <input id="nameInput" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šã•ã¨ã†ï¼‰" autocomplete="off" />
      <button class="primary" id="joinBtn">å‚åŠ ã™ã‚‹</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="avatarInput" type="file" accept="image/*" capture="environment" />
      <img id="avatarPreview" class="avatar-preview" alt="avatar preview" />
    </div>
    <div class="small">â€» ä»»æ„: ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’è¨­å®šã§ãã¾ã™ï¼ˆæ’®å½±ã¾ãŸã¯ç”»åƒé¸æŠï¼‰ã€‚</div>
    <div class="small">â€» å‚åŠ å¾Œã¯ã€Œå¸ä¼šãŒé–‹å§‹ã™ã‚‹ã¾ã§å¾…æ©Ÿã€ã«ãªã‚Šã¾ã™ã€‚</div>

    <div class="hr"></div>

    <div style="font-weight:700;">â‘¡ é€²è¡Œå¾…ã¡ï¼ˆè‡ªå‹•é·ç§»ï¼‰</div>
    <div class="row" style="margin-top:8px;">
      <div>çŠ¶æ…‹ï¼š<span class="pill" id="statePill">æœªå‚åŠ </span></div>
      <div>æ¤œå‡ºã—ãŸ game_idï¼š<span class="pill mono" id="gameIdPill">æœªæ¤œå‡º</span></div>
      <div>ã‚ãªãŸã® room_member_idï¼š<span class="pill mono" id="roomMemberPill">æœªç¢ºå®š</span></div>
    </div>

    <details style="margin-top:10px;">
      <summary class="small">ï¼ˆè£œåŠ©ï¼‰game_id ãŒæ¤œå‡ºã§ããªã„å ´åˆ</summary>
      <div class="small" style="margin-top:6px;">
        å¸ä¼šã‹ã‚‰ game_id ã‚’æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆè²¼ã‚‹ã¨è‡ªå‹•é·ç§»ã§ãã¾ã™ï¼‰ã€‚
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="manualGameId" class="mono" placeholder="game_id ã‚’è²¼ã‚Šä»˜ã‘" />
        <button class="ghost" id="setGameIdBtn">game_id ã‚’è¨­å®š</button>
      </div>
    </details>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ«ãƒ¼ãƒ ã® rosterï¼ˆå‚åŠ è¡¨æ˜ï¼‰</div>
    <ul class="list" id="rosterList"></ul>
    <div class="small">â€» roster ã¯ã€Œå‚åŠ è¡¨æ˜ãƒªã‚¹ãƒˆã€ã€‚å¸ä¼šãŒé–‹å§‹æ™‚ã« members ã¸ç¢ºå®šã—ã¾ã™ã€‚</div>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ­ã‚°</div>
    <div id="log" class="small"></div>
    <div id="error" class="err"></div>
  </div>

<script>
  const API = {
    getRoom: (roomId) => fetch(`/api/rooms/${encodeURIComponent(roomId)}`),
    addToRoster: (roomId, displayName, avatarUrl) =>
      fetch(`/api/rooms/${encodeURIComponent(roomId)}/roster`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ display_name: displayName, avatar_url: avatarUrl || null }),
      }),
    listRoster: (roomId) => fetch(`/api/rooms/${encodeURIComponent(roomId)}/roster`),
    listRoomMembers: (roomId) => fetch(`/api/rooms/${encodeURIComponent(roomId)}/members`),
    listRooms: () => fetch(`/api/rooms`),
    listGameMembers: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}/members`),
    getGame: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}`),
    judgeGame: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}/judge`),
  };

  const qs = new URLSearchParams(location.search);
  const roomId = qs.get("room_id");
  const forceWait = qs.get("force_wait") === "1";

  const LS_PREFIX = `jinrou_room_join_${roomId || "unknown"}_`;
  const LS = {
    name: LS_PREFIX + "name",
    avatar: LS_PREFIX + "avatar",
    joined: LS_PREFIX + "joined",
    roomMemberId: LS_PREFIX + "room_member_id",
    gameId: LS_PREFIX + "game_id",
    roomName: LS_PREFIX + "room_name",
  };

  const state = {
    roomId,
    roomName: localStorage.getItem(LS.roomName) || "",
    name: localStorage.getItem(LS.name) || "",
    avatarUrl: localStorage.getItem(LS.avatar) || "",
    joined: localStorage.getItem(LS.joined) === "1",
    roomMemberId: localStorage.getItem(LS.roomMemberId) || "",
    gameId: localStorage.getItem(LS.gameId) || "",
    timer: null,
  };

  const elRoomId = document.getElementById("roomId");
  const elRoomName = document.getElementById("roomName");
  const elYouName = document.getElementById("youName");
  const elState = document.getElementById("statePill");
  const elGameId = document.getElementById("gameIdPill");
  const elRoomMember = document.getElementById("roomMemberPill");

  const elRosterList = document.getElementById("rosterList");
  const elLog = document.getElementById("log");
  const elErr = document.getElementById("error");

  const nameInput = document.getElementById("nameInput");
  const avatarInput = document.getElementById("avatarInput");
  const avatarPreview = document.getElementById("avatarPreview");
  const joinBtn = document.getElementById("joinBtn");
  const clearBtn = document.getElementById("clearBtn");

  const manualGameId = document.getElementById("manualGameId");
  const setGameIdBtn = document.getElementById("setGameIdBtn");

  function log(msg){ elLog.textContent = msg; }
  function err(msg){ elErr.textContent = msg; }
  function clearMsg(){ log(""); err(""); }

  async function toJson(res){
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function setStatePill(text){ elState.textContent = text; }

  // =========================================================
  // IME / å…¥åŠ›ã®å®‰å®šåŒ–
  // =========================================================
  let imeComposing = false;
  nameInput.addEventListener("compositionstart", () => { imeComposing = true; });
  nameInput.addEventListener("compositionend",   () => { imeComposing = false; });

  async function waitImeCommitIfNeeded(){
    if (!imeComposing) return;
    await new Promise((resolve) => {
      const h = () => resolve();
      nameInput.addEventListener("compositionend", h, { once: true });
    });
    await new Promise(r => setTimeout(r, 0));
  }

  async function flushInputValue(){
    await waitImeCommitIfNeeded();
    nameInput.blur();
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  }

  // âœ… é‡è¦ï¼šãƒãƒ¼ãƒªãƒ³ã‚°æ›´æ–°ã§å…¥åŠ›æ¬„ã‚’å£Šã•ãªã„ãŸã‚ã®å®‰å…¨ setter
  function safeSetNameInput(nextValue) {
    // IMEå¤‰æ›ä¸­ã¯è§¦ã‚‰ãªã„
    if (imeComposing) return;

    // å…¥åŠ›ä¸­ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ï¼‰ã¯è§¦ã‚‰ãªã„
    if (document.activeElement === nameInput) return;

    // ã™ã§ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ã‚‹ãªã‚‰è§¦ã‚‰ãªã„
    if (nameInput.value.trim()) return;

    nameInput.value = nextValue ?? "";
  }

  function renderAvatarPreview() {
    if (state.avatarUrl) {
      avatarPreview.src = state.avatarUrl;
      avatarPreview.style.display = "block";
      return;
    }
    avatarPreview.removeAttribute("src");
    avatarPreview.style.display = "none";
  }

  async function fileToDataUrl(file) {
    return await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      reader.readAsDataURL(file);
    });
  }

  async function resizeImageDataUrl(dataUrl, maxEdge = 256, quality = 0.82) {
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.onload = () => resolve(i);
      i.onerror = () => reject(new Error("ç”»åƒã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      i.src = dataUrl;
    });
    const srcW = img.naturalWidth || img.width;
    const srcH = img.naturalHeight || img.height;
    if (!srcW || !srcH) return dataUrl;
    const scale = Math.min(1, maxEdge / Math.max(srcW, srcH));
    const dstW = Math.max(1, Math.round(srcW * scale));
    const dstH = Math.max(1, Math.round(srcH * scale));
    const canvas = document.createElement("canvas");
    canvas.width = dstW;
    canvas.height = dstH;
    const ctx = canvas.getContext("2d");
    if (!ctx) return dataUrl;
    ctx.drawImage(img, 0, 0, dstW, dstH);
    return canvas.toDataURL("image/jpeg", quality);
  }

  // =========================================================
  // æç”»
  // =========================================================
  function renderMeta(){
    elRoomId.textContent = state.roomId || "ï¼ˆroom_idãªã—ï¼‰";
    elRoomName.textContent = state.roomName ? state.roomName : "ï¼ˆåç§°ãªã—ï¼‰";
    elYouName.textContent = state.name ? state.name : "æœªç™»éŒ²";
    elGameId.textContent = state.gameId ? state.gameId : "æœªæ¤œå‡º";
    elRoomMember.textContent = state.roomMemberId ? state.roomMemberId : "æœªç¢ºå®š";

    // âœ… ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šå¸¸ã«ä»£å…¥ã—ãªã„ï¼ˆå…¥åŠ›ã‚’æ¶ˆã•ãªã„ï¼‰
    // å‚åŠ æ¸ˆã¿ãªã‚‰ state.name ã‚’è¡¨ç¤ºã—ãŸã„ãŒã€å…¥åŠ›æ¬„ã¯åŸºæœ¬è§¦ã‚‰ãªã„ã€‚
    // æœªå‚åŠ  & inputãŒç©ºã®ã¨ãã ã‘ localStorageã®nameã‚’å¾©å…ƒã™ã‚‹ã€‚
    if (!state.joined) {
      safeSetNameInput(state.name || "");
    }

    // å‚åŠ æ¸ˆã¿ãªã‚‰å…¥åŠ›æ¬„ã‚’ãƒ­ãƒƒã‚¯ï¼ˆä»»æ„ï¼šäº‹æ•…é˜²æ­¢ï¼‰
    nameInput.disabled = !!state.joined;
    avatarInput.disabled = !!state.joined;
    renderAvatarPreview();

    joinBtn.disabled = !state.roomId || state.joined;
  }

  function jumpRoleConfirm(gameId, playerId){
    location.href = `/frontend/role_confirm.html?game_id=${encodeURIComponent(gameId)}&player_id=${encodeURIComponent(playerId)}`;
  }

  function findRoomMemberIdByName(members, name){
    if (!Array.isArray(members) || !name) return "";
    const hit = members.find(m => (m.display_name || m.name) === name);
    return hit?.id || "";
  }

  function findGameMemberByRoomMemberId(gameMembers, roomMemberId){
    if (!Array.isArray(gameMembers) || !roomMemberId) return null;
    return gameMembers.find(gm => gm.room_member_id === roomMemberId) || null;
  }

  async function refreshRoomName(){
    if (!state.roomId) return;
    const r = await toJson(await API.getRoom(state.roomId));
    if (!r.ok) return;

    const nm = r.data.name || r.data.room_name || r.data.roomName || "";
    if (nm) {
      state.roomName = nm;
      localStorage.setItem(LS.roomName, nm);
      renderMeta();
    } else if (!state.roomName) {
      state.roomName = "";
      renderMeta();
    }
  }

  async function refreshRoster(){
    const r = await toJson(await API.listRoster(state.roomId));
    if (!r.ok) return;

    const roster = Array.isArray(r.data) ? r.data : (r.data.items || []);
    elRosterList.innerHTML = "";

    if (!Array.isArray(roster) || roster.length === 0) {
      const li = document.createElement("li");
      li.textContent = "ï¼ˆã¾ã èª°ã‚‚å‚åŠ ã—ã¦ã„ã¾ã›ã‚“ï¼‰";
      elRosterList.appendChild(li);
      return;
    }

    for (const x of roster){
      const li = document.createElement("li");
      li.textContent = x.display_name || x.name || x.id || "unknown";
      elRosterList.appendChild(li);
    }
  }

  async function detectRoomMemberId(){
    if (state.roomMemberId) return state.roomMemberId;
    if (!state.name) return "";

    const r = await toJson(await API.listRoomMembers(state.roomId));
    if (!r.ok) return "";

    const members = Array.isArray(r.data) ? r.data : (r.data.items || []);
    const id = findRoomMemberIdByName(members, state.name);

    if (id) {
      state.roomMemberId = id;
      localStorage.setItem(LS.roomMemberId, id);
      renderMeta();
    }
    return id;
  }

  // /api/rooms/{room_id} ã® current_game_id ã‚’è¦‹ã‚‹
  async function detectGameId(){
    const r = await toJson(await API.getRoom(state.roomId));
    if (!r.ok) return state.gameId || "";

    const gid = r.data.current_game_id || "";
    if (gid && gid !== state.gameId) {
      state.gameId = gid;
      localStorage.setItem(LS.gameId, gid);
      renderMeta();
      log("æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚GMã®é–‹å§‹ã‚’å¾…æ©Ÿã—ã¾ã™ã€‚");
      return gid;
    }
    if (!gid && state.gameId) {
      state.gameId = "";
      localStorage.removeItem(LS.gameId);
      renderMeta();
    }
    return state.gameId || "";
  }

  async function tryRedirect(){
    if (!state.gameId || !state.roomMemberId) return;

    const r = await toJson(await API.listGameMembers(state.gameId));
    if (!r.ok) return;

    const gameMembers = Array.isArray(r.data) ? r.data : (r.data.items || []);
    const me = findGameMemberByRoomMemberId(gameMembers, state.roomMemberId);
    if (!me) return;

    // started ãŒè¿”ã‚‹ç’°å¢ƒã§ã¯ started ã‚’å„ªå…ˆã€è¿”ã‚‰ãªã„ç’°å¢ƒã§ã¯ status åˆ¤å®šã§å¾…æ©Ÿã™ã‚‹
    const gameRes = await toJson(await API.getGame(state.gameId));
    if (!gameRes.ok) return;
    const startedRaw = gameRes.data.started;
    const hasStartedFlag = typeof startedRaw === "boolean";
    const status = String(gameRes.data.status || "").toUpperCase();
    if (status === "FINISHED" || status === "WOLF_WIN" || status === "VILLAGE_WIN") {
      log("ã“ã®ã‚²ãƒ¼ãƒ ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚GMãŒæ¬¡ã‚²ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚");
      return;
    }
    const waitingByStarted = hasStartedFlag && !startedRaw;
    const waitingStatus = status === "WAITING" || status === "ROLE_ASSIGN";
    if (waitingByStarted || !status || waitingStatus) {
      log("å¸ä¼šãŒGameã‚’é–‹å§‹ã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¦ã„ã¾ã™ã€‚");
      return;
    }

    // status ãŒ FINISHED ã§ãªãã¦ã‚‚ã€judge å´ã§å‹æ•—ç¢ºå®šæ¸ˆã¿ã®å ´åˆã¯æ—§ã‚²ãƒ¼ãƒ æ‰±ã„ã«ã™ã‚‹
    const judgeRes = await toJson(await API.judgeGame(state.gameId));
    if (judgeRes.ok) {
      const judge = String(judgeRes.data?.result || "").toUpperCase();
      if (judge && judge !== "ONGOING") {
        log("ã“ã®ã‚²ãƒ¼ãƒ ã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚GMãŒæ¬¡ã‚²ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚");
        return;
      }
    }

    setStatePill("é–‹å§‹æ¸ˆã¿ï¼ˆå½¹è·ç¢ºèªã¸ç§»å‹•ï¼‰");
    log("é–‹å§‹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚å½¹è·ç¢ºèªã¸ç§»å‹•ã—ã¾ã™â€¦");
    jumpRoleConfirm(state.gameId, me.id);
  }

  async function tick(){
    if (!state.roomId) return;

    await refreshRoomName();
    await refreshRoster();

    if (!state.joined) {
      setStatePill("æœªå‚åŠ ");
      return;
    }

    setStatePill("å¾…æ©Ÿä¸­ï¼ˆå¸ä¼šã®é–‹å§‹å¾…ã¡ï¼‰");

    await detectRoomMemberId();
    await detectGameId();

    if (!state.roomMemberId) {
      log("å¸ä¼šã®é–‹å§‹å¾…ã¡ã§ã™ï¼ˆroom_members ç¢ºå®šã‚’å¾…ã£ã¦ã„ã¾ã™ï¼‰");
      return;
    }
    if (!state.gameId) {
      log("å¸ä¼šã®é–‹å§‹å¾…ã¡ã§ã™ï¼ˆgame_id ã‚’æ¤œå‡ºã§ãã¦ã„ã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰");
      return;
    }
    await tryRedirect();
  }

  function startPolling(){
    if (state.timer) clearInterval(state.timer);
    state.timer = setInterval(tick, 2000);
    tick();
  }

  // =========================================================
  // ã‚¤ãƒ™ãƒ³ãƒˆ
  // =========================================================

  // Enter ã§å‚åŠ ï¼ˆIMEå¤‰æ›ä¸­ã®Enterã¯ç„¡è¦–ï¼‰
  nameInput.addEventListener("keydown", (e) => {
    if (e.isComposing || imeComposing) return;
    if (e.key === "Enter") {
      e.preventDefault();
      joinBtn.click();
    }
  });

  avatarInput.addEventListener("change", async () => {
    clearMsg();
    if (state.joined) return;
    const file = avatarInput.files && avatarInput.files[0];
    if (!file) {
      state.avatarUrl = "";
      localStorage.removeItem(LS.avatar);
      renderAvatarPreview();
      return;
    }
    if (!file.type.startsWith("image/")) {
      err("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
      avatarInput.value = "";
      return;
    }
    try {
      log("ç”»åƒã‚’å‡¦ç†ä¸­â€¦");
      const raw = await fileToDataUrl(file);
      const resized = await resizeImageDataUrl(raw, 256, 0.82);
      state.avatarUrl = resized;
      localStorage.setItem(LS.avatar, resized);
      renderAvatarPreview();
      log("ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’è¨­å®šã—ã¾ã—ãŸã€‚");
    } catch (e) {
      err(e?.message || "ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  joinBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) { err("URLã« room_id ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    if (state.joined) { err("ã™ã§ã«å‚åŠ æ¸ˆã¿ã§ã™"); return; }

    // IMEç¢ºå®šãƒ»åæ˜ ã‚’å¾…ã£ã¦ã‹ã‚‰ value ã‚’èª­ã‚€
    await flushInputValue();

    const name = (nameInput.value || "").trim();
    if (!name) { err("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    log("å‚åŠ ç™»éŒ²ä¸­â€¦");
    const r = await toJson(await API.addToRoster(state.roomId, name, state.avatarUrl));
    if (!r.ok) { err(`å‚åŠ ç™»éŒ²å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    state.name = name;
    state.joined = true;
    localStorage.setItem(LS.name, name);
    if (state.avatarUrl) {
      localStorage.setItem(LS.avatar, state.avatarUrl);
    } else {
      localStorage.removeItem(LS.avatar);
    }
    localStorage.setItem(LS.joined, "1");

    setStatePill("å¾…æ©Ÿä¸­ï¼ˆå¸ä¼šã®é–‹å§‹å¾…ã¡ï¼‰");
    log("å‚åŠ ç™»éŒ²ã—ã¾ã—ãŸã€‚å¸ä¼šãŒé–‹å§‹ã™ã‚‹ã¾ã§å¾…æ©Ÿã—ã¦ãã ã•ã„ã€‚");
    renderMeta();
    startPolling();
  });

  setGameIdBtn.addEventListener("click", () => {
    clearMsg();
    const gid = manualGameId.value.trim();
    if (!gid) { err("game_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    state.gameId = gid;
    localStorage.setItem(LS.gameId, gid);
    renderMeta();
    log("game_id ã‚’è¨­å®šã—ã¾ã—ãŸã€‚é–‹å§‹æ¸ˆã¿ãªã‚‰è‡ªå‹•ã§é·ç§»ã—ã¾ã™ã€‚");
    tick();
  });

  clearBtn.addEventListener("click", () => {
    localStorage.removeItem(LS.name);
    localStorage.removeItem(LS.avatar);
    localStorage.removeItem(LS.joined);
    localStorage.removeItem(LS.roomMemberId);
    localStorage.removeItem(LS.gameId);
    localStorage.removeItem(LS.roomName);

    state.roomName = "";
    state.name = "";
    state.avatarUrl = "";
    state.joined = false;
    state.roomMemberId = "";
    state.gameId = "";

    manualGameId.value = "";
    nameInput.disabled = false;
    nameInput.value = ""; // ã“ã“ã¯ã€Œæ¶ˆã™ã€ãªã®ã§OK
    avatarInput.disabled = false;
    avatarInput.value = "";

    clearMsg();
    setStatePill("æœªå‚åŠ ");
    log("ã“ã®ç«¯æœ«ã®å‚åŠ æƒ…å ±ã‚’æ¶ˆã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰å†å‚åŠ ã—ã¦ãã ã•ã„ã€‚");
    renderMeta();
    refreshRoomName();
    refreshRoster();
  });

  (function boot(){
    if (forceWait) {
      // å‰ã‚²ãƒ¼ãƒ ã® game_id ã‚’ä¿æŒã—ãŸã¾ã¾ã ã¨å³é·ç§»ã—å¾—ã‚‹ãŸã‚ã€å¾…æ©Ÿå¾©å¸°æ™‚ã«ã‚¯ãƒªã‚¢
      state.gameId = "";
      localStorage.removeItem(LS.gameId);
    }

    renderMeta();

    if (!state.roomId) {
      setStatePill("room_id ãŒã‚ã‚Šã¾ã›ã‚“");
      err("URLã« room_id ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹ï¼š/frontend/room_join.html?room_id=XXXX");
      joinBtn.disabled = true;
      return;
    }

    refreshRoomName();
    refreshRoster();

    if (state.joined) {
      setStatePill("å¾…æ©Ÿä¸­ï¼ˆå¸ä¼šã®é–‹å§‹å¾…ã¡ï¼‰");
      log("å‚åŠ æ¸ˆã¿ã§ã™ã€‚é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦");
      startPolling();
    } else {
      setStatePill("æœªå‚åŠ ");
    }
  })();
</script>
</body>
</html>
