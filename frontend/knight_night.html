<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>å¤œãƒ•ã‚§ãƒ¼ã‚º - é¨å£«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --castle-bg-1: #f1e7d6;
      --castle-bg-2: #d2c0a0;
      --castle-bg-3: #b59c78;
      --castle-ink: #2b2b2b;
      --castle-panel: #f8f1e3;
      --castle-border: #d1c0a2;
      --castle-shadow: rgba(27, 20, 10, 0.15);
    }
    body {
      font-family: "Yu Gothic", "Yu Gothic UI", "Meiryo", sans-serif;
      margin: 16px;
      color: var(--castle-ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,0.55), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 100% 0%, rgba(0,0,0,0.08), rgba(0,0,0,0)),
        linear-gradient(160deg, var(--castle-bg-1), var(--castle-bg-2) 60%, var(--castle-bg-3));
    }
    h1 { font-size: 1.4rem; margin-bottom: 8px; }

    .header-row{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:space-between; align-items:baseline;
      margin-bottom:8px;
    }
    .header-main{ font-size:1.1rem; font-weight:600; }
    .header-sub{ font-size:0.85rem; color:#666; }
    .you-info{ font-size:0.85rem; color:#444; }

    .members{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap:8px;
      margin-bottom:16px;
    }
    .member-card{
      border:1px solid #ccc; border-radius:8px;
      padding:8px; text-align:center;
      cursor:pointer; user-select:none;
      background:#fff; font-size:0.9rem;
      display:flex; flex-direction:column; gap:4px; min-height:72px;
      box-shadow:0 1px 2px rgba(0,0,0,0.04);
    }
    .member-card .name{ font-weight:600; }
    .member-card .sub{ font-size:0.75rem; color:#777; }
    .member-card.dead,.member-card.self{ opacity:0.4; cursor:not-allowed; }
    .member-card.selected{
      border-color:#0066cc;
      box-shadow:0 0 0 2px rgba(0,102,204,0.18);
      transform: translateY(-1px);
    }

    button{ padding:8px 16px; border-radius:999px; border:none; font-size:1rem; }
    button:disabled{ opacity:0.5; }
    .primary{ background:#0066cc; color:#fff; }

    .status{ font-size:0.9rem; margin-bottom:8px; color:#444; }
    .log{ margin-top:16px; font-size:0.9rem; white-space:pre-wrap; }
    .log > div{ margin-bottom:4px; }
    .error{ color:#b00020; }
    .success{ color:#006400; }
  </style>
</head>
<body>
  <h1>å¤œãƒ•ã‚§ãƒ¼ã‚ºï¼šé¨å£«</h1>

  <div class="header-row">
    <div>
      <div class="header-main">ä»Šå¤œã®è­·è¡›</div>
      <div class="header-sub">è‡ªåˆ†ã¨æ­»äº¡è€…ã¯é¸ã¹ã¾ã›ã‚“ï¼ˆè‡ªå·±è­·è¡›ç¦æ­¢ã®å ´åˆï¼‰ã€‚</div>
    </div>
    <div class="you-info">
      ã‚ãªãŸï¼š<strong id="me-name">ï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰</strong>ï¼ˆé¨å£«ï¼‰
    </div>
  </div>

  <div id="status" class="status"></div>
  <div id="member-list" class="members"></div>

  <button id="guard-btn" class="primary" disabled>ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è­·è¡›ã™ã‚‹</button>
  <div id="result" class="log"></div>
  <div id="host-note" class="status"></div>
  <div id="host-status" class="status"></div>
  <button id="host-morning" class="primary" style="margin-top:8px; display:none;">æœã®çµæœã¸</button>

  <script src="/frontend/js/night_common.js?v=20260221"></script>
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const game_id = params.get("game_id");
      const player_id = params.get("player_id");

      // â˜…è¿½åŠ ï¼šå‹æ•—ç¢ºå®šãªã‚‰ result.html ã¸
      setupAutoResultRedirect(game_id, player_id);

      const meNameEl = document.getElementById("me-name");
      const hostMorningBtn = document.getElementById("host-morning");

      hostMorningBtn.addEventListener("click", () => {
        location.href = `/frontend/morning.html?game_id=${encodeURIComponent(game_id)}&player_id=${encodeURIComponent(player_id)}`;
      });

      JinrouNight.initNightRolePage({
        expectedRole: "knight",
        elements: {
          statusId: "status",
          membersId: "member-list",
          buttonId: "guard-btn",
          resultId: "result",
        },

        checkAlreadyDone: async ({ gameId, me }) => {
          const url =
            `/api/games/${encodeURIComponent(gameId)}` +
            `/knight/${encodeURIComponent(me.player_id)}/guard/status`;

          const res = await fetch(url);
          if (!res.ok) return { done: false };

          const data = await res.json();
          if (!data.done) return { done: false };

          return {
            done: true,
            kind: "knight_guard",              // â†ç¨®åˆ¥ï¼ˆä»»æ„ã ãŒä»˜ã‘ã¦ãŠãã¨æ‰±ã„ã‚„ã™ã„ï¼‰
            target_member_id: data.target_member_id || null,
            message: "ä»Šå¤œã®è­·è¡›ã¯ã™ã§ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚",
          };
        },



        // â˜… æ­£ã—ã„URLï¼š/knight/{knight_member_id}/guard
        buildEndpoint: (gameId, me) => {
          if (!me || !me.player_id) throw new Error("é¨å£«æƒ…å ±ãŒä¸æ­£ã§ã™ï¼ˆplayer_idãªã—ï¼‰");
          return `/api/games/${encodeURIComponent(gameId)}/knight/${encodeURIComponent(me.player_id)}/guard`;
        },

        // â˜… Bodyã¯ target_member_id ã®ã¿ã§OK
        buildRequestBody: ({ targetMember }) => ({
          target_member_id: targetMember.id,
        }),

        buildSuccessMessage: ({ data, targetMember }) => {
          const name = data.target_name || targetMember.display_name || targetMember.name || "ç›¸æ‰‹";
          return `ğŸ›¡ï¸ ä»Šå¤œã¯ ${name} ã•ã‚“ã‚’è­·è¡›ã—ã¾ã—ãŸã€‚`;
        },

        texts: {
          loadingMe: "é¨å£«ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...",
          loadingGame: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã‚’å–å¾—ä¸­...",
          selectPrompt: "è­·è¡›ã™ã‚‹ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
          roleMismatch: "ã‚ãªãŸã¯é¨å£«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®ç”»é¢ã‹ã‚‰ã¯æ“ä½œã§ãã¾ã›ã‚“ã€‚",
          doneStatus: "ä»Šå¤œã®è­·è¡›ã¯å®Œäº†ã—ã¾ã—ãŸã€‚ä»–ã®äººã®ã‚¿ãƒ¼ãƒ³ã‚’å¾…ã£ã¦ãã ã•ã„ã€‚",
        },

        renderMembers: ({ members, me, containerEl, expectedRole, actionDone, onSelect }) => {
          if (!containerEl || !Array.isArray(members)) return;
          containerEl.innerHTML = "";

          const selfId = me?.player_id || me?.game_member_id;

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã€Œã‚ãªãŸï¼šâ—¯â—¯ã€
          const meMember = members.find((m) => m.id === selfId);
          meNameEl.textContent = meMember?.display_name || meMember?.name || "ã‚ãªãŸ";

          members.forEach((m) => {
            const card = document.createElement("div");
            card.className = "member-card";

            const isAlive = (m.is_alive !== undefined) ? m.is_alive : (m.alive !== false);
            const isSelf = selfId && m.id === selfId;
            const roleMismatch = expectedRole && me?.role !== expectedRole;

            if (!isAlive) card.classList.add("dead");
            if (isSelf) card.classList.add("self");

            const name = m.display_name || m.name || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${m.id}`;

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.textContent = name;

            const subDiv = document.createElement("div");
            subDiv.className = "sub";
            if (!isAlive) subDiv.textContent = "æ­»äº¡ã—ã¦ã„ã‚‹ãŸã‚è­·è¡›ã§ãã¾ã›ã‚“";
            else if (isSelf) subDiv.textContent = "è‡ªåˆ†è‡ªèº«ã¯è­·è¡›ã§ãã¾ã›ã‚“";
            else subDiv.textContent = "ã‚¿ãƒƒãƒ—ã—ã¦è­·è¡›å¯¾è±¡ã¨ã—ã¦é¸æŠ";

            card.appendChild(nameDiv);
            card.appendChild(subDiv);

            if (!isAlive || isSelf || actionDone || roleMismatch) {
              card.style.pointerEvents = "none";
            } else {
              card.addEventListener("click", () => {
                containerEl.querySelectorAll(".member-card").forEach((el) => el.classList.remove("selected"));
                card.classList.add("selected");
                onSelect(m);
              });
            }

            containerEl.appendChild(card);
          });
        },
      });

      if (JinrouNight?.setupHostNightPanel) {
        JinrouNight.setupHostNightPanel(game_id, player_id, {
          statusId: "host-status",
          buttonId: "host-morning",
          noteId: "host-note",
          noteText: "å¤œæ˜ã‘å‡¦ç†ã¯å¸ä¼šãŒè¡Œã„ã¾ã™",
        });
        setInterval(() => {
          JinrouNight.setupHostNightPanel(game_id, player_id, {
            statusId: "host-status",
            buttonId: "host-morning",
            noteId: "host-note",
            noteText: "å¤œæ˜ã‘å‡¦ç†ã¯å¸ä¼šãŒè¡Œã„ã¾ã™",
          });
        }, 2000);
      }
      if (JinrouNight?.watchNightToMorning) {
        JinrouNight.watchNightToMorning(game_id, player_id);
      }
    })();
  </script>
</body>
</html>
