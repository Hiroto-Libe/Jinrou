<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å½¹è·ç¢ºèª</title>
  <style>
    body {
      margin: 0;
      font-family: "Yu Gothic", "Yu Gothic UI", "Meiryo", sans-serif;
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(255,255,255,0.08), rgba(0,0,0,0)),
        radial-gradient(700px 500px at 90% 0%, rgba(0,0,0,0.35), rgba(0,0,0,0)),
        linear-gradient(160deg, #2b1f18, #120c0a 65%, #0b0706);
      color: #f8f3e6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      width: 90%;
      max-width: 420px;
      background: rgba(30, 22, 16, 0.92);
      border: 1px solid rgba(148, 125, 88, 0.6);
      border-radius: 16px;
      padding: 28px 20px 24px;
      text-align: center;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    .title { font-size: 20px; letter-spacing: .15em; opacity:.85; margin-bottom: 12px; }
    .role-label { font-size: 14px; opacity:.7; }
    .role-name { font-size: 32px; font-weight:700; margin: 8px 0; }
    .role-icon {
      font-size: 28px;
      margin-top: 6px;
    }
    .role-tag {
      display:inline-block; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(148, 125, 88, 0.7); font-size:12px; margin-bottom:14px;
    }
    .description { font-size:14px; line-height:1.6; opacity:.85; margin-bottom:20px; }
    .warning { font-size:12px; color:#fbbf24; margin-bottom:16px; }
    .note { font-size:12px; color:#94a3b8; margin: 8px 0 12px; }
    button {
      width:100%; border:none; border-radius:999px;
      padding:12px 0; font-size:16px; font-weight:600;
      letter-spacing:.1em; cursor:pointer;
      background: linear-gradient(135deg,#d2a45c,#9a6a2f);
      color:#2b1f18;
    }
    button:disabled { opacity:.4; cursor:default; }
    .countdown { font-size:11px; opacity:.75; margin-top:6px; }
    .error { color:#fecaca; font-size:13px; margin-top:12px; }
  </style>
</head>
<body>
<div class="card">
  <div class="title">ROLE CONFIRM</div>

  <div class="role-label">ã‚ãªãŸã®å½¹è·</div>
  <div class="role-name" id="roleName">...</div>
  <div class="role-icon" id="roleIcon">ğŸ•¯ï¸</div>
  <div class="role-tag" id="teamTag"></div>

  <div class="description" id="roleDesc">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <div class="note" id="host-note"></div>

  <div class="warning">
    â€» ã“ã®ç”»é¢ã¯å‘¨å›²ã®äººã«è¦‹ã‚‰ã‚Œãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„
  </div>

  <button id="okBtn" disabled>æº–å‚™OK</button>
  <div class="countdown" id="countdown">2ç§’å¾Œã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™</div>

  <div class="error" id="error"></div>
</div>

<!-- â˜…è¿½åŠ ï¼šå‹æ•—è‡ªå‹•é·ç§»ã®å…±é€šé–¢æ•°ã‚’ä½¿ã† -->
<script src="/frontend/js/night_common.js?v=20260221"></script>

<script>
  const params = new URLSearchParams(location.search);
  const gameId = params.get("game_id");
  const playerId = params.get("player_id");

  // â˜…è¿½åŠ ï¼šåˆæœŸè¡¨ç¤ºã§å‹æ•—ç¢ºå®šãªã‚‰ result.html ã¸
  // (judge!=ONGOING ã®ã¨ãã ã‘é£›ã¶)
  if (gameId && playerId && typeof setupAutoResultRedirect === "function") {
    setupAutoResultRedirect(gameId, playerId);
  }

  const roleNameEl = document.getElementById("roleName");
  const roleIconEl = document.getElementById("roleIcon");
  const roleDescEl = document.getElementById("roleDesc");
  const teamTagEl  = document.getElementById("teamTag");
  const okBtn = document.getElementById("okBtn");
  const errorEl = document.getElementById("error");
  const countdownEl = document.getElementById("countdown");
  const hostNoteEl = document.getElementById("host-note");

  const roleInfo = {
    villager: { icon:"ğŸ•¯ï¸", name:"æ‘äºº", team:"æ‘äººé™£å–¶", desc:"ç‰¹åˆ¥ãªèƒ½åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è­°è«–ã¨æŠ•ç¥¨ã§äººç‹¼ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚" },
    seer: { icon:"ğŸ”®", name:"å ã„å¸«", team:"æ‘äººé™£å–¶", desc:"æ¯æ™©1äººã‚’å ã„ã€äººç‹¼ã‹ã©ã†ã‹ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚" },
    knight: { icon:"ğŸ›¡ï¸", name:"é¨å£«", team:"æ‘äººé™£å–¶", desc:"æ¯æ™©1äººã‚’è­·è¡›ã—ã€äººç‹¼ã®è¥²æ’ƒã‹ã‚‰å®ˆã‚Œã¾ã™ã€‚" },
    werewolf: { icon:"ğŸº", name:"äººç‹¼", team:"äººç‹¼é™£å–¶", desc:"ä»²é–“ã¨å”åŠ›ã—ã€æ¯æ™©1äººã‚’è¥²æ’ƒã—ã¾ã™ã€‚" },
    wolf: { icon:"ğŸº", name:"äººç‹¼", team:"äººç‹¼é™£å–¶", desc:"ä»²é–“ã¨å”åŠ›ã—ã€æ¯æ™©1äººã‚’è¥²æ’ƒã—ã¾ã™ã€‚" },
    madman: { icon:"ğŸƒ", name:"ç‹‚äºº", team:"äººç‹¼é™£å–¶", desc:"æ‘äººã‚’æ··ä¹±ã•ã›ã€äººç‹¼ã‚’å‹åˆ©ã«å°ãã¾ã™ã€‚" },
  };

  async function fetchMe() {
    const res = await fetch(`/api/games/${gameId}/me?player_id=${encodeURIComponent(playerId)}`);
    if (!res.ok) throw new Error("å½¹è·å–å¾—å¤±æ•—");
    return await res.json();
  }

  async function fetchGame() {
    const res = await fetch(`/api/games/${gameId}`);
    if (!res.ok) throw new Error("ã‚²ãƒ¼ãƒ å–å¾—å¤±æ•—");
    return await res.json();
  }

  function goto(path) {
    location.href = `/frontend/${path}?game_id=${encodeURIComponent(gameId)}&player_id=${encodeURIComponent(playerId)}`;
  }

  async function decideNext() {
    // â˜…è¿½åŠ ï¼šãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ã‚‚å‹æ•—ç¢ºå®šãƒã‚§ãƒƒã‚¯ï¼ˆä¿é™ºï¼‰
    if (typeof redirectIfFinished === "function") {
      await redirectIfFinished(gameId, playerId);
    }

    const [me, game] = await Promise.all([fetchMe(), fetchGame()]);
    const role = me.role;
    const status = String(game.status || "").toUpperCase();

    if (status === "NIGHT") {
      if (role === "seer") return goto("seer_night.html");
      if (role === "knight") return goto("knight_night.html");
      if (role === "werewolf" || role === "wolf") return goto("night_wolf_attack.html");
      return goto("night_wait.html"); // æ‘äººãƒ»ç‹‚äºº
    }

    if (status === "DAY_DISCUSSION") return goto("day.html");

    // â˜…å¤‰æ›´ï¼šFINISHED ã¯ result.html ã¸
    if (status === "FINISHED") return goto("result.html");

    // fallback
    goto("day.html");
  }

  async function init() {
    if (!gameId || !playerId) {
      errorEl.textContent = "URLã« game_id / player_id ãŒã‚ã‚Šã¾ã›ã‚“";
      return;
    }

    // â˜…è¿½åŠ ï¼šinitä¸­ã«ã‚‚å‹æ•—ç¢ºå®šãƒã‚§ãƒƒã‚¯ï¼ˆè¡¨ç¤ºå‰ã«å¸ã„è¾¼ã‚€ï¼‰
    if (typeof redirectIfFinished === "function") {
      await redirectIfFinished(gameId, playerId);
    }

    try {
      const me = await fetchMe();
      const info = roleInfo[me.role] || { icon:"ğŸ•¯ï¸", name: me.role, team:"ä¸æ˜", desc:"èª¬æ˜ãªã—" };
      roleNameEl.textContent = info.name;
      roleIconEl.textContent = info.icon;
      teamTagEl.textContent = info.team;
      roleDescEl.textContent = info.desc;
      if (!me?.is_host) {
        hostNoteEl.textContent = "é€²è¡Œæ“ä½œã¯å¸ä¼šãŒæ‹…å½“ã—ã¾ã™";
        hostNoteEl.style.display = "block";
      } else {
        hostNoteEl.textContent = "";
        hostNoteEl.style.display = "none";
      }
    } catch (e) {
      errorEl.textContent = "å½¹è·æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
    }

    // èª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    let sec = 2;
    const timer = setInterval(() => {
      if (sec > 0) {
        countdownEl.textContent = `${sec--}ç§’å¾Œã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™`;
      } else {
        clearInterval(timer);
        okBtn.disabled = false;
        countdownEl.textContent = "æº–å‚™ãŒã§ããŸã‚‰æŠ¼ã—ã¦ãã ã•ã„";
      }
    }, 1000);
  }

  okBtn.addEventListener("click", decideNext);
  init();

  // â˜…è¿½åŠ ï¼šå¾…æ©Ÿä¸­ã‚‚å‹æ•—ç¢ºå®šã‚’ç›£è¦–ã—ã¦çµæœã¸
  if (gameId && playerId && typeof redirectIfFinished === "function") {
    setInterval(() => {
      redirectIfFinished(gameId, playerId).catch(() => {});
    }, 2000);
  }
</script>
</body>
</html>
