<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roomãƒ›ã‚¹ãƒˆï¼ˆå¸ä¼šï¼‰</title>
  <style>
    :root {
      --castle-bg-1: #f1e7d6;
      --castle-bg-2: #d2c0a0;
      --castle-bg-3: #b59c78;
      --castle-ink: #2b2b2b;
      --castle-panel: #f8f1e3;
      --castle-border: #d1c0a2;
      --castle-shadow: rgba(27, 20, 10, 0.15);
    }
    body {
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      margin: 16px;
      color: var(--castle-ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,0.55), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 100% 0%, rgba(0,0,0,0.08), rgba(0,0,0,0)),
        linear-gradient(160deg, var(--castle-bg-1), var(--castle-bg-2) 60%, var(--castle-bg-3));
    }
    h1 { margin:0 0 6px; font-size:1.3rem; }
    .muted { color:#666; font-size:.9rem; }
    .box {
      background: var(--castle-panel);
      border: 1px solid var(--castle-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px var(--castle-shadow);
      margin: 12px 0;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .primary { background:#0066cc; color:#fff; }
    .ghost { background:#eee; color:#333; }
    .danger { background:#b00020; color:#fff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    .list { margin:8px 0 0; padding-left:18px; }
    .urlbox { background:#0b1220; color:#e5e7eb; border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.85rem; overflow:auto; }
    .err { color:#b00020; white-space:pre-wrap; }
    .ok { color:#065f46; font-weight:700; }
    .small { font-size:.85rem; color:#666; }
    .card { border:1px solid #eee; border-radius:12px; padding:10px; margin-top:10px; }
  </style>
</head>
<body>
  <h1>ğŸ› Roomãƒ›ã‚¹ãƒˆï¼ˆå¸ä¼šï¼‰</h1>
  <div class="muted">Roomä½œæˆ â†’ å‚åŠ URLå…±æœ‰ â†’ rosterç¢ºèª â†’ membersç¢ºå®š â†’ Gameä½œæˆ â†’ role_confirm URLé…å¸ƒ</div>

  <div class="box">
    <div class="row">
      <div>
        <div>room_id: <span class="pill" id="roomId">æœªä½œæˆ</span></div>
        <div>game_id: <span class="pill" id="gameId">æœªä½œæˆ</span></div>
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button class="ghost" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="primary" id="createRoomBtn">Roomã‚’ä½œã‚‹</button>
      </div>
    </div>
    <div class="small">â€» ãƒªã‚»ãƒƒãƒˆã¯ã“ã®ç”»é¢ã®çŠ¶æ…‹ã‚’æ¶ˆã™ã ã‘ï¼ˆã‚µãƒ¼ãƒDBã¯æ¶ˆã—ã¾ã›ã‚“ï¼‰</div>
  </div>

  <div class="box">
    <div class="row">
      <div style="font-weight:700;">ğŸ§ª ãƒ‡ãƒãƒƒã‚°åˆæœŸåŒ–</div>
      <div class="row" style="justify-content:flex-end;">
        <input id="debugNames" type="text" placeholder="ä¾‹: å¤ªéƒ,èŠ±å­,æ¬¡éƒ" style="min-width:220px; padding:8px; border-radius:8px; border:1px solid #ddd;" />
        <input id="debugCount" type="number" min="4" max="20" value="6" style="width:80px; padding:8px; border-radius:8px; border:1px solid #ddd;" />
        <button class="danger" id="debugSeedBtn">å…¨éƒ¨åˆæœŸåŒ–ã—ã¦äººæ•°ã‚’è‡ªå‹•ç”Ÿæˆ</button>
      </div>
    </div>
    <div class="small">â€» åå‰ã‚’å…¥ã‚Œã‚‹ã¨ãã®é †ã§ç”Ÿæˆã•ã‚Œã¾ã™ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ã€‚ç©ºãªã‚‰äººæ•°ã§ç”Ÿæˆã—ã¾ã™ã€‚</div>
    <div class="small">â€» DB ã‚’å…¨æ¶ˆã—ã—ã¦ã€room / roster / members / game / start ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã€‚</div>
  </div>

  <div class="box">
    <div style="font-weight:700;">â‘  å‚åŠ URLï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å…±æœ‰ï¼‰</div>
    <div class="small">å„è‡ªãŒåå‰å…¥åŠ›ã—ã¦ roster ç™»éŒ²ã—ã¾ã™ã€‚</div>
    <div class="urlbox" id="joinUrlBox">Roomä½œæˆå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div class="row" style="justify-content:flex-end; margin-top:10px;">
      <button class="ghost" id="copyJoinUrl" disabled>å‚åŠ URLã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="ghost" id="openJoinUrl" disabled>å‚åŠ URLã‚’é–‹ã</button>
    </div>
  </div>

  <div class="box">
    <div class="row">
      <div style="font-weight:700;">â‘¡ rosterï¼ˆå‚åŠ è¡¨æ˜ï¼‰</div>
      <div class="row" style="justify-content:flex-end;">
        <button class="ghost" id="refreshRosterBtn" disabled>æ›´æ–°</button>
        <button class="primary" id="confirmMembersBtn" disabled>å‚åŠ è€…ã‚’ç¢ºå®šï¼ˆmembersç”Ÿæˆï¼‰</button>
      </div>
    </div>
    <ul class="list" id="rosterList"></ul>
    <div class="small">â€» å‚åŠ è€…ãŒæƒã£ãŸã‚‰ã€Œç¢ºå®šã€ã‚’æŠ¼ã—ã¾ã™ï¼ˆbulk_from_rosterï¼‰</div>
  </div>

  <div class="box">
    <div class="row">
      <div style="font-weight:700;">â‘¢ Gameä½œæˆ â†’ URLé…å¸ƒ</div>
      <div class="row" style="justify-content:flex-end;">
        <button class="primary" id="createGameBtn" disabled>Gameã‚’ä½œã‚‹</button>
        <button class="ghost" id="fetchGameMembersBtn" disabled>role_confirm URLã‚’æ›´æ–°</button>
      </div>
    </div>
    <div id="urlsArea" class="small" style="margin-top:8px;"></div>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ­ã‚°</div>
    <div id="log" class="small"></div>
    <div id="err" class="err"></div>
  </div>

<script>
  const state = {
    roomId: null,
    gameId: null,
    roster: [],
    gameMembers: []
  };

  const elRoomId = document.getElementById("roomId");
  const elGameId = document.getElementById("gameId");
  const elJoinUrlBox = document.getElementById("joinUrlBox");
  const elRosterList = document.getElementById("rosterList");
  const elUrlsArea = document.getElementById("urlsArea");
  const elLog = document.getElementById("log");
  const elErr = document.getElementById("err");

  const btnCreateRoom = document.getElementById("createRoomBtn");
  const btnReset = document.getElementById("resetBtn");
  const btnRefreshRoster = document.getElementById("refreshRosterBtn");
  const btnConfirmMembers = document.getElementById("confirmMembersBtn");
  const btnCreateGame = document.getElementById("createGameBtn");
  const btnFetchGameMembers = document.getElementById("fetchGameMembersBtn");
  const btnCopyJoinUrl = document.getElementById("copyJoinUrl");
  const btnOpenJoinUrl = document.getElementById("openJoinUrl");
  const btnDebugSeed = document.getElementById("debugSeedBtn");
  const inputDebugCount = document.getElementById("debugCount");
  const inputDebugNames = document.getElementById("debugNames");

  function log(t){ elLog.textContent = t; }
  function err(t){ elErr.textContent = t; }
  function clearMsg(){ log(""); err(""); }

  async function toJson(res){
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeJs(s){
    return String(s ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'");
  }

  function joinUrl(){
    if (!state.roomId) return "";
    return `${location.origin}/frontend/room_join.html?room_id=${encodeURIComponent(state.roomId)}`;
  }

  function render(){
    elRoomId.textContent = state.roomId || "æœªä½œæˆ";
    elGameId.textContent = state.gameId || "æœªä½œæˆ";

    const jurl = joinUrl();
    elJoinUrlBox.textContent = jurl || "Roomä½œæˆå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™";

    const readyRoom = !!state.roomId;
    btnRefreshRoster.disabled = !readyRoom;
    btnConfirmMembers.disabled = !readyRoom;
    btnCreateGame.disabled = !readyRoom; // membersç¢ºå®šå‰ã§ã‚‚ä¸€å¿œæŠ¼ã›ã‚‹ãŒã€é€šå¸¸ã¯ç¢ºå®šå¾Œæ¨å¥¨
    btnFetchGameMembers.disabled = !state.gameId;

    btnCopyJoinUrl.disabled = !readyRoom;
    btnOpenJoinUrl.disabled = !readyRoom;

    elRosterList.innerHTML = "";
    if (!readyRoom) {
      elRosterList.innerHTML = "<li>Roomä½œæˆå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</li>";
    } else if (!state.roster.length) {
      elRosterList.innerHTML = "<li>ã¾ã èª°ã‚‚å‚åŠ ã—ã¦ã„ã¾ã›ã‚“ï¼ˆæ›´æ–°ã§åæ˜ ï¼‰</li>";
    } else {
      for (const r of state.roster) {
        const li = document.createElement("li");
        li.textContent = r.display_name || r.name || JSON.stringify(r);
        elRosterList.appendChild(li);
      }
    }

    if (!state.gameId || !state.gameMembers.length) {
      elUrlsArea.innerHTML = "Gameä½œæˆå¾Œã«ã€Œrole_confirm URLã‚’æ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
    }
  }

  async function createRoom(){
    clearMsg();
    log("Roomä½œæˆä¸­...");
    const r = await toJson(await fetch("/api/rooms", { method:"POST" }));
    if (!r.ok) { err(`Roomä½œæˆå¤±æ•—(${r.status})\n${JSON.stringify(r.data)}`); return; }

    state.roomId = r.data.id || r.data.room_id || r.data.roomId;
    if (!state.roomId) { err(`Roomä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ room_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n${JSON.stringify(r.data)}`); return; }

    log(`Roomä½œæˆOK: ${state.roomId}`);
    render();
  }

  async function debugSeed(){
    clearMsg();
    const rawNames = (inputDebugNames.value || "").trim();
    const names = rawNames
      ? rawNames.split(",").map((s) => s.trim()).filter(Boolean)
      : [];
    const count = Number(inputDebugCount.value || "6");
    if (!names.length && (!Number.isFinite(count) || count < 4)) {
      err("äººæ•°ã¯ 4 ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    log("ãƒ‡ãƒãƒƒã‚°åˆæœŸåŒ–ä¸­...");
    const res = await fetch("/api/debug/reset_and_seed", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        player_count: names.length ? names.length : count,
        player_names: names.length ? names : null,
        start_game: true,
        room_name: "Debug Room",
      }),
    });
    const r = await toJson(res);
    if (!r.ok) {
      err(`ãƒ‡ãƒãƒƒã‚°åˆæœŸåŒ–å¤±æ•—(${r.status})\n${JSON.stringify(r.data)}`);
      return;
    }

    state.roomId = r.data.room_id;
    state.gameId = r.data.game_id;
    state.roster = Array.isArray(r.data.roster) ? r.data.roster : [];
    state.gameMembers = Array.isArray(r.data.game_members) ? r.data.game_members : [];

    log(`ãƒ‡ãƒãƒƒã‚°åˆæœŸåŒ–OK: room=${state.roomId} / game=${state.gameId}`);
    render();
    await refreshRoster();
    await fetchGameMembers();
  }

  async function refreshRoster(){
    clearMsg();
    if (!state.roomId) return;

    const res = await fetch(`/api/rooms/${encodeURIComponent(state.roomId)}/roster`);
    const r = await toJson(res);
    if (!r.ok) { err(`rosterå–å¾—å¤±æ•—(${r.status})\n${JSON.stringify(r.data)}`); return; }

    state.roster = Array.isArray(r.data) ? r.data : (r.data.items || []);
    log(`rosteræ›´æ–°: ${state.roster.length}äºº`);
    render();
  }

  async function confirmMembers(){
    clearMsg();
    if (!state.roomId) return;

    log("membersç”Ÿæˆä¸­ï¼ˆbulk_from_rosterï¼‰...");
    const res = await fetch(`/api/rooms/${encodeURIComponent(state.roomId)}/members/bulk_from_roster`, { method:"POST" });
    const r = await toJson(res);
    if (!r.ok) { err(`membersç”Ÿæˆå¤±æ•—(${r.status})\n${JSON.stringify(r.data)}`); return; }

    log("membersç”ŸæˆOKï¼ˆé–‹å§‹æº–å‚™å®Œäº†ï¼‰");
    // rosterâ†’membersåŒ–ã—ãŸã®ã§ roster ã‚’å†å–å¾—ã—ã¦è¦‹ãŸç›®ã‚’æœ€æ–°ã«ã—ã¦ãŠã
    await refreshRoster();
  }

  async function createGame(){
    clearMsg();
    if (!state.roomId) return;

    log("Gameä½œæˆä¸­...");
    const res = await fetch("/api/games", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ room_id: state.roomId }),
    });
    const r = await toJson(res);
    if (!r.ok) { err(`Gameä½œæˆå¤±æ•—(${r.status})\n${JSON.stringify(r.data)}`); return; }

    state.gameId = r.data.id || r.data.game_id || r.data.gameId;
    if (!state.gameId) { err(`Gameä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ game_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n${JSON.stringify(r.data)}`); return; }

    log(`Gameä½œæˆOK: ${state.gameId}`);
    render();
  }

  async function fetchGameMembers(){
    clearMsg();
    if (!state.gameId) return;

    log("GameMemberså–å¾—ä¸­...");
    const res = await fetch(`/api/games/${encodeURIComponent(state.gameId)}/members`);
    const r = await toJson(res);
    if (!r.ok) { err(`GameMemberså–å¾—å¤±æ•—(${r.status})\n${JSON.stringify(r.data)}`); return; }

    state.gameMembers = Array.isArray(r.data) ? r.data : (r.data.items || []);
    if (!state.gameMembers.length) { err("GameMembersãŒç©ºã§ã™"); return; }

    log(`GameMemberså–å¾—OK: ${state.gameMembers.length}äºº`);
    renderRoleConfirmUrls();
  }

  function renderRoleConfirmUrls(){
    const base = `${location.origin}/frontend/role_confirm.html`;
    const blocks = state.gameMembers.map((gm, idx) => {
      const name = gm.display_name || `player${idx+1}`;
      const playerId = gm.id; // GameMember.id
      const url = `${base}?game_id=${encodeURIComponent(state.gameId)}&player_id=${encodeURIComponent(playerId)}`;
      return `
        <div class="card">
          <div class="row">
            <div><b>${escapeHtml(name)}</b> <span class="pill">${escapeHtml(gm.role_type || "-")}</span></div>
            <div class="row" style="justify-content:flex-end;">
              <button class="ghost" onclick="copyText('${escapeJs(url)}')">ã‚³ãƒ”ãƒ¼</button>
              <button class="primary" onclick="openTab('${escapeJs(url)}')">é–‹ã</button>
            </div>
          </div>
          <div class="urlbox">${escapeHtml(url)}</div>
        </div>
      `;
    }).join("");

    elUrlsArea.innerHTML = blocks + `<div class="small">â€» ã“ã®URLã‚’å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é…ã£ã¦ãã ã•ã„ï¼ˆplayer_id ã¯ GameMember.idï¼‰</div>`;
  }

  window.copyText = async (text) => {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        log("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        return;
      }
      throw new Error("clipboard unavailable");
    } catch (e) {
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        if (ok) {
          log("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          return;
        }
      } catch (_) {}
      err("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã®å¯èƒ½æ€§ï¼‰");
    }
  };
  window.openTab = (url) => window.open(url, "_blank");

  btnCreateRoom.addEventListener("click", createRoom);
  btnRefreshRoster.addEventListener("click", refreshRoster);
  btnConfirmMembers.addEventListener("click", confirmMembers);
  btnCreateGame.addEventListener("click", createGame);
  btnFetchGameMembers.addEventListener("click", fetchGameMembers);
  btnDebugSeed.addEventListener("click", debugSeed);

  btnCopyJoinUrl.addEventListener("click", async () => {
    const u = joinUrl();
    if (!u) return;
    await window.copyText(u);
  });
  btnOpenJoinUrl.addEventListener("click", () => {
    const u = joinUrl();
    if (!u) return;
    window.openTab(u);
  });

  btnReset.addEventListener("click", () => {
    state.roomId = null;
    state.gameId = null;
    state.roster = [];
    state.gameMembers = [];
    clearMsg();
    elUrlsArea.innerHTML = "";
    render();
  });

  // rosterè‡ªå‹•æ›´æ–°ï¼ˆ2ç§’ã”ã¨ï¼‰
  setInterval(() => { if (state.roomId) refreshRoster(); }, 2000);

  render();
</script>
</body>
</html>
