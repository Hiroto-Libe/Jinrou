<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æœãƒ•ã‚§ãƒ¼ã‚º - å¤œæ˜ã‘çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { font-size: 1.4rem; margin: 0 0 8px; }
    .box { background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; }
    .primary { background:#0066cc; color:#fff; }
    .ghost { background:#eee; color:#333; }
    .status { margin-top:8px; color:#444; }
    .result { margin-top:12px; white-space:pre-wrap; font-size:1rem; }
    .success { color:#006400; }
    .error { color:#b00020; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    .small { font-size:.88rem; color:#666; }
  </style>
</head>
<body>
  <h1>æœãƒ•ã‚§ãƒ¼ã‚ºï¼šå¤œæ˜ã‘çµæœ</h1>

  <div class="box">
    <div class="small">
      ã“ã®ç”»é¢ã¯ã€Œå¤œæ˜ã‘å‡¦ç†ï¼ˆè¥²æ’ƒã®åæ˜ ï¼‰ã€ã‚’å®Ÿè¡Œã—ã€çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br>
      å¸ä¼šï¼ˆãƒ›ã‚¹ãƒˆï¼‰ãŒæ“ä½œã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="status" id="status">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="row">
      <button class="primary" id="resolve">å¤œæ˜ã‘å‡¦ç†ã‚’å®Ÿè¡Œ</button>
      <button class="ghost" id="to-day">æ˜¼ã¸é€²ã‚€</button>
      <button class="ghost" id="refresh">çŠ¶æ…‹ã‚’æ›´æ–°</button>
    </div>

    <div class="result" id="result"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const gameId = qs.get("game_id");
    const playerId = qs.get("player_id");

    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");

    function jump(path) {
      location.href = `/frontend/${path}?game_id=${encodeURIComponent(gameId)}&player_id=${encodeURIComponent(playerId)}`;
    }

    async function fetchGame() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}`);
      if (!res.ok) throw new Error(`gameå–å¾—å¤±æ•—(${res.status})`);
      return await res.json();
    }

    async function fetchMe() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/me?player_id=${encodeURIComponent(playerId)}`);
      if (!res.ok) throw new Error(`meå–å¾—å¤±æ•—(${res.status})`);
      return await res.json();
    }

    async function fetchJudge() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/judge`);
      if (!res.ok) throw new Error(`judgeå–å¾—å¤±æ•—(${res.status})`);
      return await res.json();
    }

    async function fetchNightResult() {
      const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/night_result`);
      if (!res.ok) throw new Error(`å¤œæ˜ã‘çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status})`);
      return await res.json();
    }

    function renderNightResult(data) {
      const guarded = data.guarded_success ? "ğŸ›¡ï¸ è­·è¡›æˆåŠŸï¼ˆè¥²æ’ƒå¤±æ•—ï¼‰" : "ğŸº è¥²æ’ƒãŒé€šã£ãŸ";
      const victimName = data.victim?.display_name || null;
      let msg = `${guarded}\n`;
      if (victimName) msg += `ä»Šæœã®çŠ ç‰²è€…ï¼š${victimName}\n`;
      else msg += `ä»Šæœã®çŠ ç‰²è€…ï¼šãªã—\n`;
      resultEl.innerHTML = `<div class="success">${msg}</div>`;
    }

    async function sync() {
      if (!gameId || !playerId) {
        statusEl.textContent = "game_id / player_id ãŒURLã«ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }
      try {
        const [g, me, judge] = await Promise.all([fetchGame(), fetchMe(), fetchJudge()]);
        const st = String(g.status || "").toUpperCase();
        const jr = String(judge?.result || "").toUpperCase();
        const isHost = !!me?.is_host;
        statusEl.innerHTML = `ã‚²ãƒ¼ãƒ çŠ¶æ…‹ï¼š<span class="pill">${st}</span> / å¸ä¼šï¼š${isHost ? "ã‚ãªãŸ" : "åˆ¥ã®äºº"}`;
        const resolveBtn = document.getElementById("resolve");
        const toDayBtn = document.getElementById("to-day");
        resolveBtn.disabled = !isHost || st !== "NIGHT";
        resolveBtn.title = !isHost
          ? "å¸ä¼šã®ã¿å®Ÿè¡Œã§ãã¾ã™"
          : (st === "NIGHT" ? "" : "å¤œãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿å®Ÿè¡Œã§ãã¾ã™");
        const finished = (jr === "VILLAGE_WIN" || jr === "WOLF_WIN");
        toDayBtn.disabled = st !== "DAY_DISCUSSION" || finished;
        toDayBtn.title = finished
          ? "å‹æ•—ãŒæ±ºç€ã—ãŸãŸã‚çµæœç”»é¢ã¸ç§»å‹•ã—ã¾ã™"
          : (st === "DAY_DISCUSSION" ? "" : "æ˜¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿æŠ¼ã›ã¾ã™");
        if (resolveBtn.disabled) {
          resolveBtn.classList.remove("primary");
          resolveBtn.classList.add("ghost");
        } else {
          resolveBtn.classList.add("primary");
          resolveBtn.classList.remove("ghost");
        }
        if (toDayBtn.disabled) {
          toDayBtn.classList.remove("primary");
          toDayBtn.classList.add("ghost");
        } else {
          toDayBtn.classList.add("primary");
          toDayBtn.classList.remove("ghost");
        }

        // ã‚‚ã†DAYãªã‚‰æ˜¼ã¸
        if (finished || st === "FINISHED" || st === "VILLAGE_WIN" || st === "WOLF_WIN") {
          jump("result.html");
          return;
        } else if (st === "DAY_DISCUSSION") {
          const nightResult = await fetchNightResult();
          renderNightResult(nightResult);
        } else if (st === "NIGHT") {
          resultEl.innerHTML = `<div class="small">å¤œæ˜ã‘å‡¦ç†å‰ã§ã™ã€‚å¸ä¼šãŒã€Œå¤œæ˜ã‘å‡¦ç†ã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>`;
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "çŠ¶æ…‹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      }
    }

    async function resolveNight() {
      resultEl.textContent = "";
      try {
        const [g, me] = await Promise.all([fetchGame(), fetchMe()]);
        const st = String(g.status || "").toUpperCase();
        if (st !== "NIGHT") {
          resultEl.innerHTML = `<div class="error">NIGHTã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨ï¼š${st}ï¼‰ã€‚å¤œæ˜ã‘å‡¦ç†ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚</div>`;
          return;
        }
        if (!me?.is_host) {
          resultEl.innerHTML = `<div class="error">å¸ä¼šã®ã¿å®Ÿè¡Œã§ãã¾ã™ã€‚</div>`;
          return;
        }

        const res = await fetch(`/api/games/${encodeURIComponent(gameId)}/resolve_night_simple`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}",
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          resultEl.innerHTML = `<div class="error">å¤œæ˜ã‘å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status}): ${JSON.stringify(data)}</div>`;
          return;
        }

        renderNightResult({
          guarded_success: !!data.guarded_success,
          victim: data.victim,
        });

        // çŠ¶æ…‹ãŒDAY_DISCUSSIONã«é€²ã‚“ã ã‚‰æ˜¼ã¸
        if (data.game_result?.result && data.game_result.result !== "ONGOING") {
          jump("result.html");
          return;
        }
        await sync();
      } catch (e) {
        console.error(e);
        resultEl.innerHTML = `<div class="error">${String(e)}</div>`;
      }
    }

    document.getElementById("resolve").addEventListener("click", resolveNight);
    document.getElementById("to-day").addEventListener("click", () => jump("day.html"));
    document.getElementById("refresh").addEventListener("click", sync);

    sync();
  </script>
</body>
</html>
