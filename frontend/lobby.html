<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jinrou Lobbyï¼ˆå¸ä¼šç”¨ï¼‰</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { margin:0 0 6px; font-size:1.3rem; }
    .muted { color:#666; font-size:.9rem; }
    .box { background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); margin:12px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input { padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; flex:1; min-width: 220px; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .primary { background:#0066cc; color:#fff; }
    .ghost { background:#eee; color:#333; }
    .danger { background:#b00020; color:#fff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    .list { margin:8px 0 0; padding-left: 18px; }
    .urlbox { background:#0b1220; color:#e5e7eb; border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.85rem; overflow:auto; }
    .ok { color:#065f46; }
    .err { color:#b00020; white-space:pre-wrap; }
    .small { font-size:.85rem; color:#666; }
    .split { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:900px){ .split { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <h1>ğŸº Jinrou Lobbyï¼ˆå¸ä¼šç”¨ï¼‰</h1>
  <div class="muted">Roomä½œæˆ â†’ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ  â†’ Gameä½œæˆ â†’ å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼URLç™ºè¡Œï¼ˆrole_confirmï¼‰</div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div>Room: <span class="pill" id="roomId">æœªä½œæˆ</span></div>
        <div>Game: <span class="pill" id="gameId">æœªä½œæˆ</span></div>
      </div>
      <div class="row">
        <button class="ghost" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="primary" id="createRoomBtn">Roomã‚’ä½œã‚‹</button>
      </div>
    </div>
    <div class="small">â€» ãƒªã‚»ãƒƒãƒˆã¯ã“ã®ç”»é¢ã®çŠ¶æ…‹ã‚’æ¶ˆã™ã ã‘ï¼ˆã‚µãƒ¼ãƒDBã¯æ¶ˆã—ã¾ã›ã‚“ï¼‰</div>
  </div>

  <div class="split">
    <div class="box">
      <div style="font-weight:700;">â‘  ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </div>
      <div class="row" style="margin-top:8px;">
        <input id="nameInput" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šã•ã¨ã†ï¼‰" />
        <button class="primary" id="addMemberBtn" disabled>è¿½åŠ </button>
      </div>
      <ul class="list" id="memberList"></ul>
      <div class="small">â€» Roomä½œæˆå¾Œã«è¿½åŠ ã§ãã¾ã™</div>
    </div>

    <div class="box">
      <div style="font-weight:700;">â‘¡ Gameä½œæˆï¼ˆRoom â†’ Gameï¼‰</div>
      <div class="row" style="margin-top:8px;">
        <button class="primary" id="createGameBtn" disabled>Gameã‚’ä½œã‚‹</button>
        <button class="ghost" id="fetchPlayersBtn" disabled>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼URLã‚’æ›´æ–°</button>
      </div>
      <div class="small">â€» Gameä½œæˆå¾Œã€GameMember.idï¼ˆplayer_idï¼‰ã‹ã‚‰URLã‚’ç”Ÿæˆã—ã¾ã™</div>
    </div>
  </div>

  <div class="box">
    <div style="font-weight:700;">â‘¢ å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼URLï¼ˆrole_confirmï¼‰</div>
    <div class="small">ã“ã®URLã‚’å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é…ã£ã¦ãã ã•ã„ï¼ˆplayer_id ã¯ GameMember.idï¼‰</div>
    <div id="urlsArea" style="margin-top:8px;"></div>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ­ã‚°</div>
    <div id="log" class="small"></div>
    <div id="error" class="err"></div>
  </div>

<script>
  // â˜…å¿…è¦ãªã‚‰ã“ã“ã ã‘ã‚ãªãŸã®å®Ÿè£…ã«åˆã‚ã›ã¦å¤‰æ›´
  const API = {
    createRoom: () => fetch("/api/rooms", { method: "POST" }),
    addRoomMember: (roomId, displayName) =>
      fetch(`/api/rooms/${encodeURIComponent(roomId)}/members`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ display_name: displayName }),
      }),
    createGame: (roomId) =>
      fetch("/api/games", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room_id: roomId }),
      }),
    getGameMembers: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}/members`),
  };

  const state = {
    roomId: null,
    gameId: null,
    roomMembers: [], // {display_name, id?}
    gameMembers: [], // from /games/{id}/members
  };

  const elRoomId = document.getElementById("roomId");
  const elGameId = document.getElementById("gameId");
  const elMemberList = document.getElementById("memberList");
  const elUrlsArea = document.getElementById("urlsArea");
  const elLog = document.getElementById("log");
  const elErr = document.getElementById("error");

  const btnCreateRoom = document.getElementById("createRoomBtn");
  const btnAddMember = document.getElementById("addMemberBtn");
  const btnCreateGame = document.getElementById("createGameBtn");
  const btnFetchPlayers = document.getElementById("fetchPlayersBtn");
  const btnReset = document.getElementById("resetBtn");

  const nameInput = document.getElementById("nameInput");

  function log(msg){ elLog.textContent = msg; }
  function err(msg){ elErr.textContent = msg; }
  function clearMsg(){ log(""); err(""); }

  async function toJson(res){
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function render(){
    elRoomId.textContent = state.roomId || "æœªä½œæˆ";
    elGameId.textContent = state.gameId || "æœªä½œæˆ";

    btnAddMember.disabled = !state.roomId;
    btnCreateGame.disabled = !state.roomId;
    btnFetchPlayers.disabled = !state.gameId;

    elMemberList.innerHTML = "";
    for (const m of state.roomMembers){
      const li = document.createElement("li");
      li.textContent = m.display_name;
      elMemberList.appendChild(li);
    }

    elUrlsArea.innerHTML = "";
    if (!state.gameId || !Array.isArray(state.gameMembers) || state.gameMembers.length === 0) {
      elUrlsArea.innerHTML = `<div class="small">Gameä½œæˆå¾Œã«ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼URLã‚’æ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>`;
      return;
    }

    // role_confirm ã¸ã®URLã‚’ç”Ÿæˆ
    const base = `${location.origin}/frontend/role_confirm.html`;
    const blocks = state.gameMembers.map((gm, idx) => {
      const name = gm.display_name || `player${idx+1}`;
      const playerId = gm.id; // GameMember.id
      const url = `${base}?game_id=${encodeURIComponent(state.gameId)}&player_id=${encodeURIComponent(playerId)}`;

      return `
        <div class="box" style="border-color:#eee;">
          <div class="row" style="justify-content:space-between;">
            <div><b>${escapeHtml(name)}</b> <span class="pill">${escapeHtml(gm.role_type || "-")}</span></div>
            <div class="row">
              <button class="ghost" onclick="copyText('${escapeJs(url)}')">ã‚³ãƒ”ãƒ¼</button>
              <button class="primary" onclick="openTab('${escapeJs(url)}')">é–‹ã</button>
            </div>
          </div>
          <div class="urlbox">${escapeHtml(url)}</div>
        </div>
      `;
    }).join("");

    elUrlsArea.innerHTML = blocks + `
      <div class="small">â€» è¡¨ç¤ºã•ã‚Œã‚‹ role_type ã¯å¸ä¼šç”¨ç¢ºèªã®ãŸã‚ã€‚å®Ÿé‹ç”¨ã§ã¯å„è‡ªã«URLã‚’æ¸¡ã—ã¦å€‹åˆ¥ã«ç¢ºèªã—ã¾ã™ã€‚</div>
    `;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeJs(s){
    return String(s ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'");
  }

  window.copyText = async (text) => {
    try {
      await navigator.clipboard.writeText(text);
      log("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    } catch(e) {
      err("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã®å¯èƒ½æ€§ï¼‰");
    }
  };
  window.openTab = (url) => window.open(url, "_blank");

  btnReset.addEventListener("click", () => {
    state.roomId = null;
    state.gameId = null;
    state.roomMembers = [];
    state.gameMembers = [];
    clearMsg();
    render();
  });

  btnCreateRoom.addEventListener("click", async () => {
    clearMsg();
    log("Roomä½œæˆä¸­...");
    const r = await toJson(await API.createRoom());
    if (!r.ok) { err(`Roomä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    // id ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒé•ã†å ´åˆã«å‚™ãˆã¦å¸å
    state.roomId = r.data.id || r.data.room_id || r.data.roomId;
    if (!state.roomId) { err(`Roomä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ room_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }

    log(`Roomä½œæˆOK: ${state.roomId}`);
    render();
  });

  btnAddMember.addEventListener("click", async () => {
    clearMsg();
    const name = nameInput.value.trim();
    if (!name) { err("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    log("ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ä¸­...");
    const r = await toJson(await API.addRoomMember(state.roomId, name));
    if (!r.ok) { err(`ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    state.roomMembers.push({ display_name: name });
    nameInput.value = "";
    log(`è¿½åŠ OK: ${name}`);
    render();
  });

  btnCreateGame.addEventListener("click", async () => {
    clearMsg();
    log("Gameä½œæˆä¸­...");
    const r = await toJson(await API.createGame(state.roomId));
    if (!r.ok) { err(`Gameä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    state.gameId = r.data.id || r.data.game_id || r.data.gameId;
    if (!state.gameId) { err(`Gameä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ game_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }

    log(`Gameä½œæˆOK: ${state.gameId}`);
    render();
  });

  btnFetchPlayers.addEventListener("click", async () => {
    clearMsg();
    log("GameMemberå–å¾—ä¸­...");
    const r = await toJson(await API.getGameMembers(state.gameId));
    if (!r.ok) { err(`memberså–å¾—å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    state.gameMembers = Array.isArray(r.data) ? r.data : (r.data.items || []);
    if (!Array.isArray(state.gameMembers) || state.gameMembers.length === 0) {
      err(`membersãŒç©ºã§ã™: ${JSON.stringify(r.data)}`);
      return;
    }

    log(`å–å¾—OK: ${state.gameMembers.length}äºº`);
    render();
  });

  render();
</script>
</body>
</html>
