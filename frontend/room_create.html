<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Jinrou | ãƒ«ãƒ¼ãƒ ä½œæˆï¼ˆå‚åŠ è€…ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --castle-bg-1: #f1e7d6;
      --castle-bg-2: #d2c0a0;
      --castle-bg-3: #b59c78;
      --castle-ink: #2b2b2b;
      --castle-panel: #f8f1e3;
      --castle-border: #d1c0a2;
      --castle-shadow: rgba(27, 20, 10, 0.15);
    }
    body {
      font-family: "Yu Gothic", "Yu Gothic UI", "Meiryo", sans-serif;
      margin: 16px;
      color: var(--castle-ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,0.55), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 100% 0%, rgba(0,0,0,0.08), rgba(0,0,0,0)),
        linear-gradient(160deg, var(--castle-bg-1), var(--castle-bg-2) 60%, var(--castle-bg-3));
    }
    h1 { margin:0 0 6px; font-size:1.25rem; }
    .muted { color:#666; font-size:.92rem; }
    .box {
      background: var(--castle-panel);
      border: 1px solid var(--castle-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 16px var(--castle-shadow);
      margin: 12px 0;
    }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .primary {
      background:#2563eb;   /* Tailwind blue-600 ç›¸å½“ */
      color:#fff;
      font-weight:600;
    }
    .primary:hover {
      background:#1d4ed8;
    }
    .ghost { background:#eee; color:#333; }
    .err { color:#b00020; white-space:pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem; }
    .urlbox { background:#0b1220; color:#e5e7eb; border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.85rem; overflow:auto; }
    .small { font-size:.85rem; color:#666; }
    .hr { height:1px; background:#eee; margin:10px 0; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:.95rem; }
    th { color:#666; font-weight:600; }
    input, select { padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; min-width: 260px; flex: 1; }
  </style>
</head>
<body>
  <h1>ğŸº ãƒ«ãƒ¼ãƒ ä½œæˆï¼ˆå‚åŠ è€…ï¼‰</h1>
  <div class="muted">Roomã‚’ä½œã£ã¦å‚åŠ URLã‚’é…å¸ƒ â†’ rosterãŒæƒã£ãŸã‚‰ç¢ºå®š â†’ Gameä½œæˆ/é–‹å§‹ã€‚å‚åŠ è€…ã¯ room_join ã§å¾…æ©Ÿã—ã€é–‹å§‹å¾Œã«è‡ªå‹•ã§ role_confirm ã¸ç§»å‹•ã—ã¾ã™ï¼ˆStartã‚’æŠ¼ã—ãŸäººãŒGMï¼‰ã€‚</div>

  <div class="box">
    <div style="font-weight:700;">ãƒ«ãƒ¼ãƒ åï¼ˆä»»æ„ï¼‰</div>
    <div class="small">ä¾‹ï¼‰å®¶æ—äººç‹¼ / 12æœˆå¿˜å¹´ä¼š / å‹ã ã¡ä¼š</div>
    <div class="row" style="margin-top:8px;">
      <input id="roomNameInput" placeholder="ï¼ˆæœªå…¥åŠ›ã§ã‚‚OKï¼‰" />
      <button class="primary" id="clearBtn">ã“ã®ç”»é¢ã®çŠ¶æ…‹ã‚’æ¶ˆã™</button>
      <button class="primary" id="createRoomBtn">Roomã‚’ä½œæˆ</button>
      <button class="ghost" id="deleteRoomBtn">Roomå‰Šé™¤</button>
    </div>
    <div class="hr"></div>
    <div class="row" style="justify-content:space-between;">
      <div>
        <div>room_idï¼š<span class="pill mono" id="roomIdPill">æœªä½œæˆ</span></div>
        <div>room_nameï¼š<span class="pill" id="roomNamePill">æœªè¨­å®š</span></div>
        <div>game_idï¼š<span class="pill mono" id="gameIdPill">æœªä½œæˆ</span></div>
        <div>çŠ¶æ…‹ï¼š<span class="pill" id="statePill">æœªé–‹å§‹</span></div>
      </div>
    </div>
    <div class="small">â€»ã€ŒçŠ¶æ…‹ã‚’æ¶ˆã™ã€ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜æƒ…å ±ã®ã¿ã‚’æ¶ˆã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒDBã¯æ¶ˆã—ã¾ã›ã‚“ï¼‰</div>
  </div>

  <div class="box">
    <div style="font-weight:700;">â‘  å‚åŠ URLï¼ˆå‚åŠ è€…ã«å…±æœ‰ï¼‰</div>
    <div class="small">å‚åŠ è€…ã¯ã“ã®URLã‚’é–‹ã„ã¦åå‰ã‚’ç™»éŒ²ã—ã¾ã™ï¼ˆrosterï¼‰</div>
    <div id="joinArea" style="margin-top:8px;"></div>
    <div id="joinQr" style="margin-top:10px;"></div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">â‘¡ rosterï¼ˆå‚åŠ è¡¨æ˜ï¼‰</div>
        <div class="small">äººæ•°ãŒæƒã£ãŸã‚‰ã€Œrosterã‚’ç¢ºå®šã€â†’ members ã¸å¤‰æ›ï¼ˆbulk_from_rosterï¼‰</div>
      </div>
      <div class="row">
        <button class="primary" id="refreshRosterBtn">rosteræ›´æ–°</button>
        <button class="ghost" id="bulkBtn" disabled>rosterã‚’ç¢ºå®šï¼ˆbulk_from_rosterï¼‰</button>
      </div>
    </div>
    <div id="rosterArea"></div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">â‘¡.5 ãƒ¡ãƒ³ãƒç·¨é›†ï¼ˆã‚²ãƒ¼ãƒ é–“ã®ã¿ï¼‰</div>
        <div class="small">ã‚²ãƒ¼ãƒ çµ‚äº†å¾Œã«åŒã˜Roomã§æ¬¡ã‚²ãƒ¼ãƒ ã‚’è¡Œã†ãŸã‚ã®å‚åŠ è€…è¿½åŠ ãƒ»å‰Šé™¤</div>
      </div>
      <div class="row">
        <button class="ghost" id="refreshMembersBtn">membersæ›´æ–°</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="memberNameInput" placeholder="è¿½åŠ ã™ã‚‹è¡¨ç¤ºå" />
      <button class="primary" id="addMemberBtn">ãƒ¡ãƒ³ãƒè¿½åŠ </button>
    </div>
    <div id="membersArea" style="margin-top:8px;"></div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">â‘¢ Gameä½œæˆ & é–‹å§‹</div>
        <div class="small">ç¢ºå®šå¾Œã« Game ä½œæˆ â†’ Startï¼ˆå¿…è¦ãªã‚‰ role_assignï¼‰</div>
      </div>
      <div class="row">
        <button class="primary" id="createGameBtn" disabled>Gameä½œæˆ</button>
        <button class="primary" id="restartGameBtn" disabled>åŒã˜ãƒ¡ãƒ³ãƒã§æ¬¡ã‚²ãƒ¼ãƒ ä½œæˆ</button>
        <button class="primary" id="startGameBtn" disabled>Start</button>
        <button class="ghost" id="assignRolesBtn" disabled>å½¹è·å‰²ã‚Šå½“ã¦ï¼ˆrole_assignï¼‰</button>
      </div>
    </div>
    <div style="margin-top:8px;">
      <div class="small">ã‚²ãƒ¼ãƒ é–‹å§‹è€…ï¼ˆGMï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="row" style="margin-top:6px;">
        <select id="starterSelect" disabled>
          <option value="">ï¼ˆGameMemberså–å¾—å¾Œã«é¸æŠï¼‰</option>
        </select>
      </div>
    </div>
  </div>

  <div class="box">
    <div style="font-weight:700;">â‘£ è‡ªå‹•é·ç§»ã®ç¢ºèª</div>
    <div class="small">å‚åŠ è€…ã¯ room_join ã§å¾…æ©Ÿã—ã€GMãŒStartã™ã‚‹ã¨è‡ªå‹•ã§ role_confirm ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
    <div id="playersArea" style="margin-top:8px;"></div>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ­ã‚°</div>
    <div id="log" class="small"></div>
    <div id="error" class="err"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
  const API_BASE = (location.protocol === "file:" || location.port === "5500")
    ? "http://127.0.0.1:8000"
    : "";
  const apiFetch = (path, options) => fetch(`${API_BASE}${path}`, options);

  const PAGE_BASE = location.pathname.replace(/\/[^/]*$/, "");
  const pageUrl = (file) => `${location.origin}${PAGE_BASE}/${file}`;
  const params = new URLSearchParams(location.search);

  const API = {
    createRoom: (payload) => apiFetch("/api/rooms", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: payload ? JSON.stringify(payload) : null,
    }),
    getRoom: (roomId) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}`),

    listRoster: (roomId) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}/roster`),
    bulkFromRoster: (roomId) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}/members/bulk_from_roster`, { method: "POST" }),
    listRoomMembers: (roomId) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}/members`),
    addRoomMember: (roomId, payload) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}/members`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    }),
    removeRoomMember: (roomId, memberId) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}/members/${encodeURIComponent(memberId)}`, {
      method: "DELETE",
    }),
    deleteRoom: (roomId) => apiFetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
      method: "DELETE",
    }),

    createGame: (roomId) => apiFetch("/api/games", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId }),
    }),
    startGame: (gameId, requesterMemberId) => apiFetch(`/api/games/${encodeURIComponent(gameId)}/start`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ requester_member_id: requesterMemberId }),
    }),
    assignRoles: (gameId) => apiFetch(`/api/games/${encodeURIComponent(gameId)}/role_assign`, { method: "POST" }),
    listGameMembers: (gameId) => apiFetch(`/api/games/${encodeURIComponent(gameId)}/members`),
  };

  const LS = {
    roomId: "jinrou_host_room_id",
    roomName: "jinrou_host_room_name",
    gameId: "jinrou_host_game_id",
    bulkDone: "jinrou_host_bulk_done",
    startMemberId: "jinrou_host_start_member_id",
  };

  const state = {
    roomId: localStorage.getItem(LS.roomId) || "",
    roomName: localStorage.getItem(LS.roomName) || "",
    gameId: localStorage.getItem(LS.gameId) || "",
    bulkDone: localStorage.getItem(LS.bulkDone) === "1",
    startMemberId: localStorage.getItem(LS.startMemberId) || "",
    roster: [],
    roomMembers: [],
    gameMembers: [],
  };

  const roomNameInput = document.getElementById("roomNameInput");
  const roomIdPill = document.getElementById("roomIdPill");
  const roomNamePill = document.getElementById("roomNamePill");
  const gameIdPill = document.getElementById("gameIdPill");
  const statePill = document.getElementById("statePill");

  const joinArea = document.getElementById("joinArea");
  const joinQr = document.getElementById("joinQr");
  const rosterArea = document.getElementById("rosterArea");
  const membersArea = document.getElementById("membersArea");
  const playersArea = document.getElementById("playersArea");

  const logEl = document.getElementById("log");
  const errEl = document.getElementById("error");

  const createRoomBtn = document.getElementById("createRoomBtn");
  const refreshRosterBtn = document.getElementById("refreshRosterBtn");
  const refreshMembersBtn = document.getElementById("refreshMembersBtn");
  const bulkBtn = document.getElementById("bulkBtn");
  const memberNameInput = document.getElementById("memberNameInput");
  const addMemberBtn = document.getElementById("addMemberBtn");

  const createGameBtn = document.getElementById("createGameBtn");
  const restartGameBtn = document.getElementById("restartGameBtn");
  const startGameBtn = document.getElementById("startGameBtn");
  const assignRolesBtn = document.getElementById("assignRolesBtn");
  const starterSelect = document.getElementById("starterSelect");

  const clearBtn = document.getElementById("clearBtn");
  const deleteRoomBtn = document.getElementById("deleteRoomBtn");

  function log(msg){ logEl.textContent = msg; }
  function err(msg){ errEl.textContent = msg; }
  function clearMsg(){ log(""); err(""); }

  async function toJson(res){
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeJs(s){
    return String(s ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'");
  }

  window.copyText = async (text) => {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        log("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        return;
      }
      throw new Error("clipboard unavailable");
    } catch (e) {
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        if (ok) {
          log("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          return;
        }
      } catch (_) {}
      err("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã®å¯èƒ½æ€§ï¼‰");
    }
  };
  window.openTab = (url) => window.open(url, "_blank");

  function setState(text){ statePill.textContent = text; }

  function applyStateFromQuery(){
    const roomIdFromQuery = (params.get("room_id") || "").trim();
    if (!roomIdFromQuery) return;

    if (state.roomId !== roomIdFromQuery) {
      state.roomId = roomIdFromQuery;
      state.gameId = "";
      state.bulkDone = false;
      state.startMemberId = "";
      state.roster = [];
      state.gameMembers = [];

      localStorage.setItem(LS.roomId, roomIdFromQuery);
      localStorage.removeItem(LS.gameId);
      localStorage.removeItem(LS.bulkDone);
      localStorage.removeItem(LS.startMemberId);
    }
  }

  function renderJoinQr(text){
    if (!joinQr) return;
    if (!text) {
      joinQr.innerHTML = "";
      return;
    }
    joinQr.innerHTML = `<div class="small">QRã§å‚åŠ URLã‚’å…±æœ‰</div>`;
    const box = document.createElement("div");
    box.style.marginTop = "6px";
    const canvas = document.createElement("canvas");
    box.appendChild(canvas);
    joinQr.appendChild(box);

    if (!window.QRCode || !QRCode.toCanvas) {
      const img = document.createElement("img");
      img.alt = "å‚åŠ URL QR";
      img.width = 220;
      img.height = 220;
      img.style.display = "block";
      img.style.border = "1px solid #ddd";
      img.style.borderRadius = "8px";
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(text)}`;
      img.onerror = () => {
        joinQr.innerHTML = `<div class="err">QRè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯æ‹¡å¼µæ©Ÿèƒ½ã®åˆ¶é™ï¼‰</div>`;
      };
      box.appendChild(img);
      return;
    }

    QRCode.toCanvas(canvas, text, { width: 220, margin: 1 }, (err) => {
      if (err) {
        joinQr.innerHTML = `<div class="err">QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
      }
    });
  }

  function render(){
    roomNameInput.value = state.roomName || "";

    roomIdPill.textContent = state.roomId ? state.roomId : "æœªä½œæˆ";
    roomNamePill.textContent = state.roomName ? state.roomName : "ï¼ˆåç§°ãªã—ï¼‰";
    gameIdPill.textContent = state.gameId ? state.gameId : "æœªä½œæˆ";

    const hasRoom = !!state.roomId;
    const hasGame = !!state.gameId;

    // refreshRosterBtn.disabled = !hasRoom;
    // refreshRosterBtn.disabled = !hasRoom;

    const rosterCount = (state.roster || []).length;
    const canBulk = hasRoom && rosterCount >= 6;

    bulkBtn.disabled = !canBulk;
    bulkBtn.className = canBulk ? "primary" : "ghost";

    createGameBtn.disabled = !hasRoom;
    restartGameBtn.disabled = !hasRoom;
    addMemberBtn.disabled = !hasRoom;
    refreshMembersBtn.disabled = !hasRoom;
    deleteRoomBtn.disabled = !hasRoom;
    const memberIds = new Set((state.gameMembers || []).map((m) => m.id));
    if (state.startMemberId && !memberIds.has(state.startMemberId)) {
      state.startMemberId = "";
      localStorage.removeItem(LS.startMemberId);
    }

    startGameBtn.disabled = !hasGame || !state.startMemberId;
    assignRolesBtn.disabled = !hasGame;
    starterSelect.disabled = !hasGame || memberIds.size === 0;

    if (!hasRoom) {
      joinArea.innerHTML = `<div class="small">Roomä½œæˆå¾Œã«å‚åŠ URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>`;
      renderJoinQr("");
    } else {
      const joinUrl = `${pageUrl("room_join.html")}?room_id=${encodeURIComponent(state.roomId)}`;
      const hostUrl = `${pageUrl("room_create.html")}?room_id=${encodeURIComponent(state.roomId)}`;
      joinArea.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div style="flex:1;">
            <div class="urlbox">${escapeHtml(joinUrl)}</div>
            <div class="small">â€» å‚åŠ è€…ã«ã“ã®URLã‚’é€ã£ã¦ãã ã•ã„ï¼ˆLINE/QR/å£é ­ãªã©ï¼‰</div>
            <div class="small" style="margin-top:8px;">å¸ä¼šã®å†é–‹URLï¼ˆåˆ¥ç«¯æœ«ã§Roomã‚’å¼•ãç¶™ãï¼‰</div>
            <div class="urlbox">${escapeHtml(hostUrl)}</div>
          </div>
          <div class="row">
            <button class="primary" onclick="copyText('${escapeJs(joinUrl)}')">ã‚³ãƒ”ãƒ¼</button>
            <button class="ghost" onclick="openTab('${escapeJs(joinUrl)}')">é–‹ã</button>
            <button class="ghost" onclick="copyText('${escapeJs(hostUrl)}')">å¸ä¼šURLã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>
      `;
      renderJoinQr(joinUrl);
    }

    if (!hasRoom) {
      rosterArea.innerHTML = `<div class="small">Roomä½œæˆå¾Œã« roster ã‚’ç¢ºèªã§ãã¾ã™ã€‚</div>`;
    } else {
      const rows = (state.roster || []).map((x, i) => {
        const name = x.display_name || x.name || x.id || `member${i+1}`;
        return `<tr><td>${escapeHtml(name)}</td></tr>`;
      }).join("");

      rosterArea.innerHTML = `
        <div class="row" style="justify-content:space-between; margin-top:8px;">
          <div>å‚åŠ äººæ•°ï¼š<span class="pill">${(state.roster || []).length}</span></div>
          <div class="small">${state.bulkDone ? "âœ… rosterç¢ºå®šæ¸ˆã¿" : "ï¼ˆæœªç¢ºå®šï¼‰"}</div>
        </div>
        <table>
          <thead><tr><th>roster</th></tr></thead>
          <tbody>${rows || `<tr><td>ï¼ˆã¾ã èª°ã‚‚å‚åŠ ã—ã¦ã„ã¾ã›ã‚“ï¼‰</td></tr>`}</tbody>
        </table>
      `;
    }

    if (!hasRoom) {
      membersArea.innerHTML = `<div class="small">Roomä½œæˆå¾Œã« members ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</div>`;
    } else {
      const rows = (state.roomMembers || []).map((m, i) => {
        const name = m.display_name || m.name || m.id || `member${i+1}`;
        return `
          <tr>
            <td>${escapeHtml(name)}</td>
            <td style="text-align:right;">
              <button class="ghost" onclick="removeMember('${escapeJs(m.id)}')">å‰Šé™¤</button>
            </td>
          </tr>
        `;
      }).join("");
      membersArea.innerHTML = `
        <div>ç¢ºå®šãƒ¡ãƒ³ãƒæ•°ï¼š<span class="pill">${(state.roomMembers || []).length}</span></div>
        <table>
          <thead><tr><th>members</th><th></th></tr></thead>
          <tbody>${rows || `<tr><td colspan="2">ï¼ˆã¾ã ç¢ºå®šãƒ¡ãƒ³ãƒã¯ã„ã¾ã›ã‚“ï¼‰</td></tr>`}</tbody>
        </table>
      `;
    }

    if (!hasGame || !Array.isArray(state.gameMembers) || state.gameMembers.length === 0) {
      playersArea.innerHTML = `<div class="small">Gameä½œæˆå¾Œã«å‚åŠ è€…ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å€‹åˆ¥URLã®é…å¸ƒã¯ä¸è¦ã§ã™ã€‚</div>`;
    } else {
      const rows = state.gameMembers.map((gm, idx) => {
        const name = gm.display_name || gm.name || `player${idx+1}`;
        const hostBadge = gm.id === state.startMemberId ? `<span class="pill">GM</span>` : "";
        return `<tr><td>${escapeHtml(name)}</td><td>${hostBadge}</td></tr>`;
      }).join("");
      playersArea.innerHTML = `
        <table>
          <thead><tr><th>å‚åŠ è€…</th><th>å‚™è€ƒ</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="small" style="margin-top:8px;">â€» Startå¾Œã€å‚åŠ è€…ç«¯æœ«ã® room_join ã¯è‡ªå‹•é·ç§»ã—ã¾ã™ã€‚</div>
      `;
    }

    const startOptions = (state.gameMembers || []).map((gm, idx) => {
      const name = gm.display_name || gm.name || `player${idx+1}`;
      const selected = gm.id === state.startMemberId ? "selected" : "";
      return `<option value="${escapeHtml(gm.id)}" ${selected}>${escapeHtml(name)}</option>`;
    }).join("");
    starterSelect.innerHTML = `<option value="">ï¼ˆé–‹å§‹è€…ã‚’é¸æŠï¼‰</option>${startOptions}`;
    starterSelect.value = state.startMemberId || "";
  }

  async function refreshRoster(){
    if (!state.roomId) return;
    const r = await toJson(await API.listRoster(state.roomId));
    if (!r.ok) { err(`rosterå–å¾—å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.roster = Array.isArray(r.data) ? r.data : (r.data.items || []);
    render();
  }

  async function refreshRoomMembers(){
    if (!state.roomId) return;
    const r = await toJson(await API.listRoomMembers(state.roomId));
    if (!r.ok) { err(`memberså–å¾—å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.roomMembers = Array.isArray(r.data) ? r.data : (r.data.items || []);
    render();
  }

  async function refreshGameMembers(){
    if (!state.gameId) return;
    const r = await toJson(await API.listGameMembers(state.gameId));
    if (!r.ok) { err(`game memberså–å¾—å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.gameMembers = Array.isArray(r.data) ? r.data : (r.data.items || []);
    if (!state.startMemberId && state.gameMembers.length > 0) {
      state.startMemberId = state.gameMembers[0].id;
      localStorage.setItem(LS.startMemberId, state.startMemberId);
    }
    render();
  }

  window.removeMember = async (memberId) => {
    clearMsg();
    if (!state.roomId || !memberId) return;
    if (!confirm("ã“ã®ãƒ¡ãƒ³ãƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    setState("ãƒ¡ãƒ³ãƒå‰Šé™¤ä¸­...");
    const r = await toJson(await API.removeRoomMember(state.roomId, memberId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`ãƒ¡ãƒ³ãƒå‰Šé™¤å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    setState("ãƒ¡ãƒ³ãƒå‰Šé™¤OK");
    await refreshRoomMembers();
  };

  async function createRoomWithName(roomName){
    // roomNameãŒç©ºãªã‚‰ bodyç„¡ã—ã§ä½œã‚‹ï¼ˆå—ã‘ä»˜ã‘ã‚‹å®Ÿè£…ãŒå¤šã„ï¼‰
    if (!roomName) return await toJson(await API.createRoom(null));

    // 422ç­‰ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒé•ã†å¯èƒ½æ€§ã«å‚™ãˆã¦è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
    const r1 = await toJson(await API.createRoom({ name: roomName }));
    if (r1.ok) return r1;

    const r2 = await toJson(await API.createRoom({ room_name: roomName }));
    return r2.ok ? r2 : r1; // ä¸¡æ–¹å¤±æ•—ãªã‚‰æœ€åˆã®ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
  }

  async function pullRoomNameIfPossible(roomId){
    const r = await toJson(await API.getRoom(roomId));
    if (!r.ok) return;
    const nm = r.data.name || r.data.room_name || r.data.roomName || "";
    if (nm) {
      state.roomName = nm;
      localStorage.setItem(LS.roomName, nm);
      render();
    }
  }

  clearBtn.addEventListener("click", () => {
    localStorage.removeItem(LS.roomId);
    localStorage.removeItem(LS.roomName);
    localStorage.removeItem(LS.gameId);
    localStorage.removeItem(LS.bulkDone);
    localStorage.removeItem(LS.startMemberId);

    state.roomId = "";
    state.roomName = "";
    state.gameId = "";
    state.bulkDone = false;
    state.startMemberId = "";
    state.roster = [];
    state.roomMembers = [];
    state.gameMembers = [];

    clearMsg();
    setState("æœªé–‹å§‹");
    render();
  });

  createRoomBtn.addEventListener("click", async () => {
    clearMsg();
    setState("Roomä½œæˆä¸­...");

    const name = roomNameInput.value.trim();
    state.roomName = name;
    localStorage.setItem(LS.roomName, name);

    const r = await createRoomWithName(name);
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Roomä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    const roomId = r.data.id || r.data.room_id || r.data.roomId;
    if (!roomId) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Roomä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ room_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }

    state.roomId = roomId;
    localStorage.setItem(LS.roomId, roomId);

    // æ–°Roomä½œæˆã§gameå´ã¯ãƒªã‚»ãƒƒãƒˆï¼ˆæ··ä¹±é˜²æ­¢ï¼‰
    state.gameId = "";
    state.bulkDone = false;
    state.startMemberId = "";
    state.roster = [];
    state.gameMembers = [];
    localStorage.removeItem(LS.gameId);
    localStorage.removeItem(LS.bulkDone);
    localStorage.removeItem(LS.startMemberId);

    // ã‚‚ã—ã‚µãƒ¼ãƒãŒroom_nameã‚’ä¿å­˜ã—ã¦è¿”ã™ãªã‚‰å›å
    await pullRoomNameIfPossible(roomId);

    setState("Roomä½œæˆOKï¼ˆå‚åŠ URLã‚’é…å¸ƒï¼‰");
    render();
    await refreshRoster();
    await refreshRoomMembers();
  });

  refreshRosterBtn.addEventListener("click", async () => {
    clearMsg();
    setState("rosteræ›´æ–°ä¸­...");
    await refreshRoster();
    setState("rosteræ›´æ–°OK");
  });

  bulkBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    setState("rosterç¢ºå®šä¸­ï¼ˆbulk_from_rosterï¼‰...");
    const r = await toJson(await API.bulkFromRoster(state.roomId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`bulk_from_rosterå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.bulkDone = true;
    localStorage.setItem(LS.bulkDone, "1");
    setState("rosterç¢ºå®šOKï¼ˆGameä½œæˆã¸ï¼‰");
    render();
    await refreshRoomMembers();
  });

  refreshMembersBtn.addEventListener("click", async () => {
    clearMsg();
    setState("membersæ›´æ–°ä¸­...");
    await refreshRoomMembers();
    setState("membersæ›´æ–°OK");
  });

  addMemberBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    const name = (memberNameInput.value || "").trim();
    if (!name) { err("è¿½åŠ ã™ã‚‹è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    setState("ãƒ¡ãƒ³ãƒè¿½åŠ ä¸­...");
    const r = await toJson(await API.addRoomMember(state.roomId, { display_name: name }));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`ãƒ¡ãƒ³ãƒè¿½åŠ å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    memberNameInput.value = "";
    setState("ãƒ¡ãƒ³ãƒè¿½åŠ OK");
    await refreshRoomMembers();
  });

  createGameBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    setState("Gameä½œæˆä¸­...");
    const r = await toJson(await API.createGame(state.roomId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Gameä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    const gameId = r.data.id || r.data.game_id || r.data.gameId;
    if (!gameId) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Gameä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ game_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }
    state.gameId = gameId;
    localStorage.setItem(LS.gameId, gameId);
    setState("Gameä½œæˆOKï¼ˆStartã¸ï¼‰");
    render();
    await refreshGameMembers();
  });

  restartGameBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    setState("æ¬¡ã‚²ãƒ¼ãƒ ä½œæˆä¸­ï¼ˆåŒã˜ãƒ¡ãƒ³ãƒï¼‰...");
    const r = await toJson(await API.createGame(state.roomId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`æ¬¡ã‚²ãƒ¼ãƒ ä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    const gameId = r.data.id || r.data.game_id || r.data.gameId;
    if (!gameId) { setState("ã‚¨ãƒ©ãƒ¼"); err(`æ¬¡ã‚²ãƒ¼ãƒ ä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ game_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }
    state.gameId = gameId;
    localStorage.setItem(LS.gameId, gameId);
    state.startMemberId = "";
    localStorage.removeItem(LS.startMemberId);
    setState("æ¬¡ã‚²ãƒ¼ãƒ ä½œæˆOKï¼ˆStartå¾…ã¡ï¼‰");
    render();
    await refreshGameMembers();
  });

  deleteRoomBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    if (!confirm("ã“ã®Roomã‚’å‰Šé™¤ã—ã¾ã™ã€‚é–¢é€£ã™ã‚‹ã‚²ãƒ¼ãƒ æƒ…å ±ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
    setState("Roomå‰Šé™¤ä¸­...");
    const r = await toJson(await API.deleteRoom(state.roomId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Roomå‰Šé™¤å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    localStorage.removeItem(LS.roomId);
    localStorage.removeItem(LS.roomName);
    localStorage.removeItem(LS.gameId);
    localStorage.removeItem(LS.bulkDone);
    localStorage.removeItem(LS.startMemberId);
    state.roomId = "";
    state.roomName = "";
    state.gameId = "";
    state.bulkDone = false;
    state.startMemberId = "";
    state.roster = [];
    state.roomMembers = [];
    state.gameMembers = [];
    setState("Roomå‰Šé™¤å®Œäº†");
    render();
  });

  startGameBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.gameId) return;
    if (!state.startMemberId) { err("ã‚²ãƒ¼ãƒ é–‹å§‹è€…ï¼ˆGMï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    setState("Startä¸­...");
    const r = await toJson(await API.startGame(state.gameId, state.startMemberId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Startå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    setState("Start OKï¼ˆå‚åŠ è€…ã¯è‡ªå‹•é·ç§»ï¼‰");
    await refreshGameMembers();
  });

  assignRolesBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.gameId) return;
    setState("å½¹è·å‰²ã‚Šå½“ã¦ä¸­ï¼ˆrole_assignï¼‰...");
    const r = await toJson(await API.assignRoles(state.gameId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`role_assignå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    setState("å½¹è·å‰²ã‚Šå½“ã¦OK");
    await refreshGameMembers();
  });

  (async function boot(){
    applyStateFromQuery();
    clearMsg();
    render();

    if (state.roomId) {
      setState("å†é–‹ï¼ˆå‚åŠ URLã‚’é…å¸ƒï¼‰");
      await pullRoomNameIfPossible(state.roomId);
      await refreshRoster();
      await refreshRoomMembers();
    } else {
      setState("æœªé–‹å§‹");
    }

    if (state.gameId) await refreshGameMembers();
  })();
</script>
</body>
</html>
