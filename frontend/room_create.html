<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Jinrou | ãƒ«ãƒ¼ãƒ ä½œæˆï¼ˆå¸ä¼šç”¨ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; background:#f5f5f5; }
    h1 { margin:0 0 6px; font-size:1.25rem; }
    .muted { color:#666; font-size:.92rem; }
    .box { background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); margin:12px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:.82rem; color:#333; }
    button { padding:10px 14px; border-radius:999px; border:none; font-size:1rem; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .primary {
      background:#2563eb;   /* Tailwind blue-600 ç›¸å½“ */
      color:#fff;
      font-weight:600;
    }
    .primary:hover {
      background:#1d4ed8;
    }
    .ghost { background:#eee; color:#333; }
    .err { color:#b00020; white-space:pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem; }
    .urlbox { background:#0b1220; color:#e5e7eb; border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.85rem; overflow:auto; }
    .small { font-size:.85rem; color:#666; }
    .hr { height:1px; background:#eee; margin:10px 0; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:.95rem; }
    th { color:#666; font-weight:600; }
    input { padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; min-width: 260px; flex: 1; }
  </style>
</head>
<body>
  <h1>ğŸº ãƒ«ãƒ¼ãƒ ä½œæˆï¼ˆå¸ä¼šç”¨ï¼‰</h1>
  <div class="muted">Roomã‚’ä½œã£ã¦å‚åŠ URLã‚’é…å¸ƒ â†’ rosterãŒæƒã£ãŸã‚‰ç¢ºå®š â†’ Gameä½œæˆ/é–‹å§‹ â†’ å„è‡ªã® role_confirm URL ã‚’é…å¸ƒ</div>

  <div class="box">
    <div style="font-weight:700;">ãƒ«ãƒ¼ãƒ åï¼ˆä»»æ„ï¼‰</div>
    <div class="small">ä¾‹ï¼‰å®¶æ—äººç‹¼ / 12æœˆå¿˜å¹´ä¼š / å‹ã ã¡ä¼š</div>
    <div class="row" style="margin-top:8px;">
      <input id="roomNameInput" placeholder="ï¼ˆæœªå…¥åŠ›ã§ã‚‚OKï¼‰" />
      <button class="primary" id="clearBtn">ã“ã®ç”»é¢ã®çŠ¶æ…‹ã‚’æ¶ˆã™</button>
      <button class="primary" id="createRoomBtn">Roomã‚’ä½œæˆ</button>
    </div>
    <div class="hr"></div>
    <div class="row" style="justify-content:space-between;">
      <div>
        <div>room_idï¼š<span class="pill mono" id="roomIdPill">æœªä½œæˆ</span></div>
        <div>room_nameï¼š<span class="pill" id="roomNamePill">æœªè¨­å®š</span></div>
        <div>game_idï¼š<span class="pill mono" id="gameIdPill">æœªä½œæˆ</span></div>
        <div>çŠ¶æ…‹ï¼š<span class="pill" id="statePill">æœªé–‹å§‹</span></div>
      </div>
    </div>
    <div class="small">â€»ã€ŒçŠ¶æ…‹ã‚’æ¶ˆã™ã€ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜æƒ…å ±ã®ã¿ã‚’æ¶ˆã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒDBã¯æ¶ˆã—ã¾ã›ã‚“ï¼‰</div>
  </div>

  <div class="box">
    <div style="font-weight:700;">â‘  å‚åŠ URLï¼ˆå‚åŠ è€…ã«å…±æœ‰ï¼‰</div>
    <div class="small">å‚åŠ è€…ã¯ã“ã®URLã‚’é–‹ã„ã¦åå‰ã‚’ç™»éŒ²ã—ã¾ã™ï¼ˆrosterï¼‰</div>
    <div id="joinArea" style="margin-top:8px;"></div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">â‘¡ rosterï¼ˆå‚åŠ è¡¨æ˜ï¼‰</div>
        <div class="small">äººæ•°ãŒæƒã£ãŸã‚‰ã€Œrosterã‚’ç¢ºå®šã€â†’ members ã¸å¤‰æ›ï¼ˆbulk_from_rosterï¼‰</div>
      </div>
      <div class="row">
        <button class="primary" id="refreshRosterBtn">rosteræ›´æ–°</button>
        <button class="ghost" id="bulkBtn" disabled>rosterã‚’ç¢ºå®šï¼ˆbulk_from_rosterï¼‰</button>
      </div>
    </div>
    <div id="rosterArea"></div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">â‘¢ Gameä½œæˆ & é–‹å§‹</div>
        <div class="small">ç¢ºå®šå¾Œã« Game ä½œæˆ â†’ Startï¼ˆå¿…è¦ãªã‚‰ role_assignï¼‰</div>
      </div>
      <div class="row">
        <button class="primary" id="createGameBtn" disabled>Gameä½œæˆ</button>
        <button class="primary" id="startGameBtn" disabled>Start</button>
        <button class="ghost" id="assignRolesBtn" disabled>å½¹è·å‰²ã‚Šå½“ã¦ï¼ˆrole_assignï¼‰</button>
      </div>
    </div>
  </div>

  <div class="box">
    <div style="font-weight:700;">â‘£ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼URLï¼ˆrole_confirmï¼‰</div>
    <div class="small">å„è‡ªã«é…å¸ƒã™ã‚‹URLã§ã™ï¼ˆplayer_id ã¯ GameMember.idï¼‰</div>
    <div id="playersArea" style="margin-top:8px;"></div>
  </div>

  <div class="box">
    <div style="font-weight:700;">ãƒ­ã‚°</div>
    <div id="log" class="small"></div>
    <div id="error" class="err"></div>
  </div>

<script>
  const API = {
    createRoom: (payload) => fetch("/api/rooms", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: payload ? JSON.stringify(payload) : null,
    }),
    getRoom: (roomId) => fetch(`/api/rooms/${encodeURIComponent(roomId)}`),

    listRoster: (roomId) => fetch(`/api/rooms/${encodeURIComponent(roomId)}/roster`),
    bulkFromRoster: (roomId) => fetch(`/api/rooms/${encodeURIComponent(roomId)}/members/bulk_from_roster`, { method: "POST" }),

    createGame: (roomId) => fetch("/api/games", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ room_id: roomId }),
    }),
    startGame: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}/start`, { method: "POST" }),
    assignRoles: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}/role_assign`, { method: "POST" }),
    listGameMembers: (gameId) => fetch(`/api/games/${encodeURIComponent(gameId)}/members`),
  };

  const LS = {
    roomId: "jinrou_host_room_id",
    roomName: "jinrou_host_room_name",
    gameId: "jinrou_host_game_id",
    bulkDone: "jinrou_host_bulk_done",
  };

  const state = {
    roomId: localStorage.getItem(LS.roomId) || "",
    roomName: localStorage.getItem(LS.roomName) || "",
    gameId: localStorage.getItem(LS.gameId) || "",
    bulkDone: localStorage.getItem(LS.bulkDone) === "1",
    roster: [],
    gameMembers: [],
  };

  const roomNameInput = document.getElementById("roomNameInput");
  const roomIdPill = document.getElementById("roomIdPill");
  const roomNamePill = document.getElementById("roomNamePill");
  const gameIdPill = document.getElementById("gameIdPill");
  const statePill = document.getElementById("statePill");

  const joinArea = document.getElementById("joinArea");
  const rosterArea = document.getElementById("rosterArea");
  const playersArea = document.getElementById("playersArea");

  const logEl = document.getElementById("log");
  const errEl = document.getElementById("error");

  const createRoomBtn = document.getElementById("createRoomBtn");
  const refreshRosterBtn = document.getElementById("refreshRosterBtn");
  const bulkBtn = document.getElementById("bulkBtn");

  const createGameBtn = document.getElementById("createGameBtn");
  const startGameBtn = document.getElementById("startGameBtn");
  const assignRolesBtn = document.getElementById("assignRolesBtn");

  const clearBtn = document.getElementById("clearBtn");

  function log(msg){ logEl.textContent = msg; }
  function err(msg){ errEl.textContent = msg; }
  function clearMsg(){ log(""); err(""); }

  async function toJson(res){
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeJs(s){
    return String(s ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'");
  }

  window.copyText = async (text) => {
    try { await navigator.clipboard.writeText(text); log("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    catch(e){ err("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã®å¯èƒ½æ€§ï¼‰"); }
  };
  window.openTab = (url) => window.open(url, "_blank");

  function setState(text){ statePill.textContent = text; }

  function render(){
    roomNameInput.value = state.roomName || "";

    roomIdPill.textContent = state.roomId ? state.roomId : "æœªä½œæˆ";
    roomNamePill.textContent = state.roomName ? state.roomName : "ï¼ˆåç§°ãªã—ï¼‰";
    gameIdPill.textContent = state.gameId ? state.gameId : "æœªä½œæˆ";

    const hasRoom = !!state.roomId;
    const hasGame = !!state.gameId;

    // refreshRosterBtn.disabled = !hasRoom;
    // refreshRosterBtn.disabled = !hasRoom;

    const rosterCount = (state.roster || []).length;
    const canBulk = hasRoom && rosterCount >= 6;

    bulkBtn.disabled = !canBulk;
    bulkBtn.className = canBulk ? "primary" : "ghost";

    createGameBtn.disabled = !hasRoom;
    startGameBtn.disabled = !hasGame;
    assignRolesBtn.disabled = !hasGame;

    if (!hasRoom) {
      joinArea.innerHTML = `<div class="small">Roomä½œæˆå¾Œã«å‚åŠ URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>`;
    } else {
      const joinUrl = `${location.origin}/frontend/room_join.html?room_id=${encodeURIComponent(state.roomId)}`;
      joinArea.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div style="flex:1;">
            <div class="urlbox">${escapeHtml(joinUrl)}</div>
            <div class="small">â€» å‚åŠ è€…ã«ã“ã®URLã‚’é€ã£ã¦ãã ã•ã„ï¼ˆLINE/QR/å£é ­ãªã©ï¼‰</div>
          </div>
          <div class="row">
            <button class="primary" onclick="copyText('${escapeJs(joinUrl)}')">ã‚³ãƒ”ãƒ¼</button>
            <button class="ghost" onclick="openTab('${escapeJs(joinUrl)}')">é–‹ã</button>
          </div>
        </div>
      `;
    }

    if (!hasRoom) {
      rosterArea.innerHTML = `<div class="small">Roomä½œæˆå¾Œã« roster ã‚’ç¢ºèªã§ãã¾ã™ã€‚</div>`;
    } else {
      const rows = (state.roster || []).map((x, i) => {
        const name = x.display_name || x.name || x.id || `member${i+1}`;
        return `<tr><td>${escapeHtml(name)}</td></tr>`;
      }).join("");

      rosterArea.innerHTML = `
        <div class="row" style="justify-content:space-between; margin-top:8px;">
          <div>å‚åŠ äººæ•°ï¼š<span class="pill">${(state.roster || []).length}</span></div>
          <div class="small">${state.bulkDone ? "âœ… rosterç¢ºå®šæ¸ˆã¿" : "ï¼ˆæœªç¢ºå®šï¼‰"}</div>
        </div>
        <table>
          <thead><tr><th>roster</th></tr></thead>
          <tbody>${rows || `<tr><td>ï¼ˆã¾ã èª°ã‚‚å‚åŠ ã—ã¦ã„ã¾ã›ã‚“ï¼‰</td></tr>`}</tbody>
        </table>
      `;
    }

    if (!hasGame || !Array.isArray(state.gameMembers) || state.gameMembers.length === 0) {
      playersArea.innerHTML = `<div class="small">Gameé–‹å§‹å¾Œã«ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼URLï¼ˆrole_confirmï¼‰ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>`;
    } else {
      const base = `${location.origin}/frontend/role_confirm.html`;
      const blocks = state.gameMembers.map((gm, idx) => {
        const name = gm.display_name || gm.name || `player${idx+1}`;
        const playerId = gm.id;
        const url = `${base}?game_id=${encodeURIComponent(state.gameId)}&player_id=${encodeURIComponent(playerId)}`;
        const role = gm.role_type || "-";
        return `
          <div class="box" style="border-color:#eee;">
            <div class="row" style="justify-content:space-between;">
              <div><b>${escapeHtml(name)}</b> <span class="pill">${escapeHtml(role)}</span></div>
              <div class="row">
                <button class="primary" onclick="copyText('${escapeJs(url)}')">ã‚³ãƒ”ãƒ¼</button>
                <button class="ghost" onclick="openTab('${escapeJs(url)}')">é–‹ã</button>
              </div>
            </div>
            <div class="urlbox">${escapeHtml(url)}</div>
          </div>
        `;
      }).join("");
      playersArea.innerHTML = blocks;
    }
  }

  async function refreshRoster(){
    if (!state.roomId) return;
    const r = await toJson(await API.listRoster(state.roomId));
    if (!r.ok) { err(`rosterå–å¾—å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.roster = Array.isArray(r.data) ? r.data : (r.data.items || []);
    render();
  }

  async function refreshGameMembers(){
    if (!state.gameId) return;
    const r = await toJson(await API.listGameMembers(state.gameId));
    if (!r.ok) { err(`game memberså–å¾—å¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.gameMembers = Array.isArray(r.data) ? r.data : (r.data.items || []);
    render();
  }

  async function createRoomWithName(roomName){
    // roomNameãŒç©ºãªã‚‰ bodyç„¡ã—ã§ä½œã‚‹ï¼ˆå—ã‘ä»˜ã‘ã‚‹å®Ÿè£…ãŒå¤šã„ï¼‰
    if (!roomName) return await toJson(await API.createRoom(null));

    // 422ç­‰ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒé•ã†å¯èƒ½æ€§ã«å‚™ãˆã¦è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
    const r1 = await toJson(await API.createRoom({ name: roomName }));
    if (r1.ok) return r1;

    const r2 = await toJson(await API.createRoom({ room_name: roomName }));
    return r2.ok ? r2 : r1; // ä¸¡æ–¹å¤±æ•—ãªã‚‰æœ€åˆã®ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
  }

  async function pullRoomNameIfPossible(roomId){
    const r = await toJson(await API.getRoom(roomId));
    if (!r.ok) return;
    const nm = r.data.name || r.data.room_name || r.data.roomName || "";
    if (nm) {
      state.roomName = nm;
      localStorage.setItem(LS.roomName, nm);
      render();
    }
  }

  clearBtn.addEventListener("click", () => {
    localStorage.removeItem(LS.roomId);
    localStorage.removeItem(LS.roomName);
    localStorage.removeItem(LS.gameId);
    localStorage.removeItem(LS.bulkDone);

    state.roomId = "";
    state.roomName = "";
    state.gameId = "";
    state.bulkDone = false;
    state.roster = [];
    state.gameMembers = [];

    clearMsg();
    setState("æœªé–‹å§‹");
    render();
  });

  createRoomBtn.addEventListener("click", async () => {
    clearMsg();
    setState("Roomä½œæˆä¸­...");

    const name = roomNameInput.value.trim();
    state.roomName = name;
    localStorage.setItem(LS.roomName, name);

    const r = await createRoomWithName(name);
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Roomä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }

    const roomId = r.data.id || r.data.room_id || r.data.roomId;
    if (!roomId) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Roomä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ room_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }

    state.roomId = roomId;
    localStorage.setItem(LS.roomId, roomId);

    // æ–°Roomä½œæˆã§gameå´ã¯ãƒªã‚»ãƒƒãƒˆï¼ˆæ··ä¹±é˜²æ­¢ï¼‰
    state.gameId = "";
    state.bulkDone = false;
    state.roster = [];
    state.gameMembers = [];
    localStorage.removeItem(LS.gameId);
    localStorage.removeItem(LS.bulkDone);

    // ã‚‚ã—ã‚µãƒ¼ãƒãŒroom_nameã‚’ä¿å­˜ã—ã¦è¿”ã™ãªã‚‰å›å
    await pullRoomNameIfPossible(roomId);

    setState("Roomä½œæˆOKï¼ˆå‚åŠ URLã‚’é…å¸ƒï¼‰");
    render();
    await refreshRoster();
  });

  refreshRosterBtn.addEventListener("click", async () => {
    clearMsg();
    setState("rosteræ›´æ–°ä¸­...");
    await refreshRoster();
    setState("rosteræ›´æ–°OK");
  });

  bulkBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    setState("rosterç¢ºå®šä¸­ï¼ˆbulk_from_rosterï¼‰...");
    const r = await toJson(await API.bulkFromRoster(state.roomId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`bulk_from_rosterå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    state.bulkDone = true;
    localStorage.setItem(LS.bulkDone, "1");
    setState("rosterç¢ºå®šOKï¼ˆGameä½œæˆã¸ï¼‰");
    render();
  });

  createGameBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.roomId) return;
    setState("Gameä½œæˆä¸­...");
    const r = await toJson(await API.createGame(state.roomId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Gameä½œæˆå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    const gameId = r.data.id || r.data.game_id || r.data.gameId;
    if (!gameId) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Gameä½œæˆã¯æˆåŠŸã—ã¾ã—ãŸãŒ game_id ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${JSON.stringify(r.data)}`); return; }
    state.gameId = gameId;
    localStorage.setItem(LS.gameId, gameId);
    setState("Gameä½œæˆOKï¼ˆStartã¸ï¼‰");
    render();
    await refreshGameMembers();
  });

  startGameBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.gameId) return;
    setState("Startä¸­...");
    const r = await toJson(await API.startGame(state.gameId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`Startå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    setState("Start OKï¼ˆURLé…å¸ƒï¼‰");
    await refreshGameMembers();
  });

  assignRolesBtn.addEventListener("click", async () => {
    clearMsg();
    if (!state.gameId) return;
    setState("å½¹è·å‰²ã‚Šå½“ã¦ä¸­ï¼ˆrole_assignï¼‰...");
    const r = await toJson(await API.assignRoles(state.gameId));
    if (!r.ok) { setState("ã‚¨ãƒ©ãƒ¼"); err(`role_assignå¤±æ•—(${r.status}): ${JSON.stringify(r.data)}`); return; }
    setState("å½¹è·å‰²ã‚Šå½“ã¦OKï¼ˆURLé…å¸ƒï¼‰");
    await refreshGameMembers();
  });

  (async function boot(){
    clearMsg();
    render();

    if (state.roomId) {
      setState("å†é–‹ï¼ˆå‚åŠ URLã‚’é…å¸ƒï¼‰");
      await pullRoomNameIfPossible(state.roomId);
      await refreshRoster();
    } else {
      setState("æœªé–‹å§‹");
    }

    if (state.gameId) await refreshGameMembers();
  })();
</script>
</body>
</html>
